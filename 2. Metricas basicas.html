<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRADING SUITE | Programa 2 - M√©tricas B√°sicas</title>
    <!-- Incluir Chart.js para gr√°ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILOS CYBERPUNK BASE (Mismo que Programa 1) ===== */
        :root {
            --bg-1: #06060a;
            --bg-2: #0b0011;
            --neon-cyan: #00f0ff;
            --neon-blue: #6f5cff;
            --neon-magenta: #ff4cff;
            --neon-green: #00ff88;
            --neon-red: #ff5555;
            --neon-yellow: #ffff00;
            --neon-orange: #ff8c00;
            --neon-purple: #a855f7;
            --muted: rgba(230, 238, 248, 0.55);
            --card-bg: rgba(20, 20, 40, 0.85);
            --glow-cyan: 0 0 10px rgba(0, 240, 255, 0.5);
            --glow-green: 0 0 10px rgba(0, 255, 136, 0.5);
            --glow-red: 0 0 10px rgba(255, 85, 85, 0.5);
            --glow-yellow: 0 0 10px rgba(255, 255, 0, 0.5);
            --radius: 8px;
            --border-thin: 1px solid rgba(0, 240, 255, 0.2);
            font-family: 'Segoe UI', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-1);
            color: #dfefff;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: var(--border-thin);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: var(--glow-cyan);
            letter-spacing: 1px;
        }

        .program-indicator {
            background: rgba(0, 240, 255, 0.1);
            padding: 5px 15px;
            border-radius: var(--radius);
            border: var(--border-thin);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* ===== PANEL DE IMPORTACI√ìN ===== */
        .import-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
        }

        .panel-title {
            color: var(--neon-cyan);
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: var(--border-thin);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-source-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 240, 255, 0.1);
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-badge {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            color: var(--muted);
        }

        .stat-value {
            color: var(--neon-green);
            font-weight: 600;
        }

        .io-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-blue));
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--neon-cyan);
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(90deg, var(--neon-green), rgba(0, 255, 136, 0.7));
            color: #000;
        }

        .btn-warning {
            background: linear-gradient(90deg, var(--neon-yellow), var(--neon-orange));
            color: #000;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .file-input {
            display: none;
        }

        /* ===== PANEL DE M√âTRICAS ===== */
        .metrics-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius);
            padding: 15px;
            border: 1px solid rgba(0, 240, 255, 0.1);
        }

        .section-title {
            color: var(--neon-cyan);
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: var(--border-thin);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 240, 255, 0.05);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-weight: 700;
            font-size: 16px;
            text-align: right;
        }

        .metric-value.positive {
            color: var(--neon-green);
        }

        .metric-value.negative {
            color: var(--neon-red);
        }

        .metric-value.neutral {
            color: var(--neon-cyan);
        }

        .metric-subtext {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
            text-align: right;
        }

        /* ===== PANEL INFERIOR ===== */
        .bottom-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .bottom-panel {
                grid-template-columns: 1fr;
            }
        }

        /* ===== TABLA DE DATOS ===== */
        .data-table-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--neon-cyan);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: var(--border-thin);
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.05);
            font-size: 12px;
        }

        .data-table tr:hover {
            background: rgba(0, 240, 255, 0.05);
        }

        /* ===== PANEL DE GR√ÅFICAS ===== */
        .charts-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
        }

        .chart-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .chart-tab {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 4px;
            color: var(--muted);
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .chart-tab:hover {
            background: rgba(0, 240, 255, 0.1);
            color: var(--neon-cyan);
        }

        .chart-tab.active {
            background: rgba(0, 240, 255, 0.2);
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 250px;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: var(--muted);
            text-align: center;
        }

        /* ===== PROGRESS BARS ===== */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .progress-win {
            background: linear-gradient(90deg, var(--neon-green), #00cc6a);
        }

        .progress-loss {
            background: linear-gradient(90deg, var(--neon-red), #cc0000);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .badge-danger {
            background: rgba(255, 85, 85, 0.2);
            color: var(--neon-red);
            border: 1px solid rgba(255, 85, 85, 0.3);
        }

        .badge-warning {
            background: rgba(255, 255, 0, 0.2);
            color: var(--neon-yellow);
            border: 1px solid rgba(255, 255, 0, 0.3);
        }

        .badge-info {
            background: rgba(0, 240, 255, 0.2);
            color: var(--neon-cyan);
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        /* ===== UTILITIES ===== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-magenta));
            border-radius: 3px;
        }

        /* Estilos para paginaci√≥n */
        .pagination-controls {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-top: var(--border-thin);
        }

        .btn-pagination {
            background: rgba(0, 240, 255, 0.1);
            border: var(--border-thin);
            color: var(--neon-cyan);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            min-width: 30px;
        }

        .btn-pagination:hover:not(:disabled) {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: var(--glow-cyan);
        }

        .btn-pagination:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-pagination.active {
            background: rgba(0, 240, 255, 0.3);
            box-shadow: var(--glow-cyan);
        }

        .page-number {
            background: rgba(0, 240, 255, 0.1);
            border: var(--border-thin);
            color: var(--neon-cyan);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            min-width: 30px;
            text-align: center;
        }

        .page-number:hover {
            background: rgba(0, 240, 255, 0.2);
        }

        .page-number.active {
            background: rgba(0, 240, 255, 0.3);
            box-shadow: var(--glow-cyan);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div style="width: 40px; height: 40px; border-radius: 6px; background: linear-gradient(45deg, var(--neon-cyan), var(--neon-magenta));"></div>
                <div>
                    <h1>TRADING SUITE</h1>
                    <div style="font-size: 12px; color: var(--muted);">Professional Trading Analytics</div>
                </div>
            </div>
            <div class="program-indicator">
                PROGRAMA 2: <strong style="color: var(--neon-green);">M√©tricas B√°sicas</strong>
                <button id="debugBtn" class="btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                    üêõ Debug
                </button>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Panel de Importaci√≥n -->
            <div class="import-panel">
                <div class="panel-title">
                    <span>üìÅ IMPORTAR DATOS</span>
                </div>
                
                <div class="data-source-info">
                    <div style="color: var(--muted); font-size: 13px; margin-bottom: 10px;">
                        Importa datos del <strong style="color: var(--neon-cyan);">Programa 1</strong> para analizar m√©tricas b√°sicas
                    </div>
                    
                    <div id="dataStats" class="data-stats">
                        <div class="stat-badge">
                            <span class="stat-label">Trades Cargados:</span>
                            <span class="stat-value" id="loadedTradesCount">0</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-label">Per√≠odo:</span>
                            <span class="stat-value" id="dataPeriod">N/A</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-label">√öltima Actualizaci√≥n:</span>
                            <span class="stat-value" id="lastUpdate">N/A</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-label">Estado:</span>
                            <span class="stat-value" id="dataStatus">Esperando datos</span>
                        </div>
                    </div>
                </div>

                <div class="io-buttons">
                    <label for="importJsonInput" class="btn btn-primary" style="cursor: pointer;">
                        <span>üì§</span> Importar JSON
                        <input type="file" id="importJsonInput" class="file-input" accept=".json">
                    </label>
                    
                    <label for="importCsvInput" class="btn btn-secondary" style="cursor: pointer;">
                        <span>üì§</span> Importar CSV
                        <input type="file" id="importCsvInput" class="file-input" accept=".csv">
                    </label>
                    
                    <button class="btn btn-success" id="calculateMetricsBtn" disabled>
                        <span>üìä</span> Calcular M√©tricas
                    </button>
                    
                    <button class="btn btn-warning" id="clearDataBtn">
                        <span>üóëÔ∏è</span> Limpiar Datos
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                    <div style="font-size: 11px; color: var(--neon-cyan); margin-bottom: 5px;">üîó Compatibilidad:</div>
                    <div style="font-size: 10px; color: var(--muted);">
                        ‚Ä¢ <strong>Entrada:</strong> JSON/CSV del Programa 1<br>
                        ‚Ä¢ <strong>Salida:</strong> JSON para Programa 3, CSV para reportes<br>
                        ‚Ä¢ <strong>Procesamiento:</strong> 20+ m√©tricas de trading
                    </div>
                </div>
            </div>

            <!-- Panel de M√©tricas -->
            <div class="metrics-panel">
                <div class="panel-title">
                    <span>üìà M√âTRICAS B√ÅSICAS CALCULADAS</span>
                    <span id="metricsStatus" style="font-size: 12px; color: var(--neon-yellow);">(Sin datos)</span>
                </div>
                
                <div class="metrics-grid">
                    <!-- Secci√≥n 1: Totales -->
                    <div class="metric-section">
                        <div class="section-title">
                            <span>‚ö°</span> TOTALES
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">N√∫mero de Trades</span>
                            <div>
                                <span class="metric-value neutral" id="metricTotalTrades">0</span>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Win Rate</span>
                            <div>
                                <span class="metric-value positive" id="metricWinRate">0%</span>
                                <div class="progress-bar">
                                    <div class="progress-fill progress-win" id="winRateBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Profit Factor</span>
                            <div>
                                <span class="metric-value positive" id="metricProfitFactor">0.00</span>
                                <div class="metric-subtext" id="profitFactorRating">(Sin datos)</div>
                            </div>
                        </div>

                        <div class="metric-row">
                            <span class="metric-label">Tasa de Ganancia Net</span>
                            <div>
                                <span class="metric-value neutral" id="metricNetProfitRatio">0.00</span>
                                <div class="metric-subtext">Ganancia/Inversi√≥n</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 2: Rendimiento -->
                    <div class="metric-section">
                        <div class="section-title">
                            <span>üöÄ</span> RENDIMIENTO
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Expectancy (R)</span>
                            <div>
                                <span class="metric-value neutral" id="metricExpectancy">0.00</span>
                                <div class="metric-subtext">R m√∫ltiple promedio</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Payoff Ratio</span>
                            <div>
                                <span class="metric-value positive" id="metricPayoffRatio">0.00</span>
                                <div class="metric-subtext">Ganancia/P√©rdida</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Avg Win / Avg Loss</span>
                            <div>
                                <span class="metric-value positive" id="metricWinLossRatio">0.00</span>
                                <div class="metric-subtext">Relaci√≥n media</div>
                            </div>
                        </div>

                        <div class="metric-row">
                            <span class="metric-label">Recovery Factor</span>
                            <div>
                                <span class="metric-value neutral" id="metricRecoveryFactor">0.00</span>
                                <div class="metric-subtext">Ganancia/Drawdown</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 3: Operaciones Extremas -->
                    <div class="metric-section">
                        <div class="section-title">
                            <span>üî•</span> OPERACIONES EXTREMAS
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Mejor Trade (R)</span>
                            <div>
                                <span class="metric-value positive" id="metricBestTrade">0.00</span>
                                <div class="metric-subtext" id="bestTradeInfo">Fecha: N/A</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Peor Trade (R)</span>
                            <div>
                                <span class="metric-value negative" id="metricWorstTrade">0.00</span>
                                <div class="metric-subtext" id="worstTradeInfo">Fecha: N/A</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Rango (R)</span>
                            <div>
                                <span class="metric-value neutral" id="metricRange">0.00</span>
                                <div class="metric-subtext">Diferencia m√°ximo-m√≠nimo</div>
                            </div>
                        </div>

                        <div class="metric-row">
                            <span class="metric-label">Consistencia (%)</span>
                            <div>
                                <span class="metric-value neutral" id="metricConsistency">0.00</span>
                                <div class="metric-subtext">Estabilidad resultados</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 4: Gesti√≥n del Riesgo -->
                    <div class="metric-section">
                        <div class="section-title">
                            <span>üõ°Ô∏è</span> GESTI√ìN DEL RIESGO
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Max Drawdown (%)</span>
                            <div>
                                <span class="metric-value negative" id="metricMaxDrawdown">0.00%</span>
                                <div class="metric-subtext" id="drawdownInfo">M√°xima ca√≠da</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Racha M√°x. Wins</span>
                            <div>
                                <span class="metric-value positive" id="metricMaxWinStreak">0</span>
                                <div class="metric-subtext">Consecutivos</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Racha M√°x. Losses</span>
                            <div>
                                <span class="metric-value negative" id="metricMaxLossStreak">0</span>
                                <div class="metric-subtext">Consecutivos</div>
                            </div>
                        </div>

                        <div class="metric-row">
                            <span class="metric-label">Risk of Ruin (%)</span>
                            <div>
                                <span class="metric-value neutral" id="metricRiskOfRuin">0.00%</span>
                                <div class="metric-subtext">Prob. quiebra</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: var(--border-thin);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: var(--muted);">
                            <span id="calculationTime">√öltimo c√°lculo: N/A</span>
                        </div>
                        <div class="io-buttons" style="margin-top: 0;">
                            <button class="btn btn-primary" id="exportJsonBtn" disabled>
                                <span>üì•</span> Exportar JSON
                            </button>
                            <button class="btn btn-secondary" id="exportCsvBtn" disabled>
                                <span>üì•</span> Exportar CSV
                            </button>
                            <button class="btn btn-success" id="generateChartsBtn" disabled>
                                <span>üìä</span> Generar Gr√°ficas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Inferior -->
        <div class="bottom-panel">
            <!-- Tabla de Trades -->
            <div class="data-table-container">
                <div class="panel-title" style="margin-bottom: 15px;">
                    <span>üìã TRADES IMPORTADOS</span>
                    <span style="font-size: 12px; color: var(--muted);" id="tableSummary">Mostrando 0 trades</span>
                </div>
                
                <table class="data-table" id="tradesTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Instrumento</th>
                            <th>Direcci√≥n</th>
                            <th>PnL ($)</th>
                            <th>PnL (R)</th>
                            <th>Resultado</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                                Importa datos del Programa 1 para ver los trades
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- Controles de paginaci√≥n se insertar√°n aqu√≠ -->
            </div>

            <!-- Panel de Gr√°ficas -->
            <div class="charts-container">
                <div class="panel-title">
                    <span>üìä VISUALIZACI√ìN DE M√âTRICAS</span>
                </div>
                
                <div class="chart-tabs" id="chartTabs">
                    <button class="chart-tab active" data-chart="distribution">Distribuci√≥n PnL</button>
                    <button class="chart-tab" data-chart="winLoss">Win/Loss Ratio</button>
                    <button class="chart-tab" data-chart="streaks">Rachas</button>
                    <button class="chart-tab" data-chart="monthly">Rendimiento Mensual</button>
                    <button class="chart-tab" data-chart="instruments">Por Instrumento</button>
                    <button class="chart-tab" data-chart="equity">Curva de Equity</button>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-placeholder" id="chartPlaceholder">
                        <div style="font-size: 48px; color: var(--neon-cyan); opacity: 0.3;">üìä</div>
                        <div style="color: var(--muted); max-width: 200px;">
                            <strong>Visualizaci√≥n de M√©tricas</strong><br>
                            <small>Calcula m√©tricas y haz clic en "Generar Gr√°ficas"</small>
                        </div>
                    </div>
                    <canvas id="metricsChart" class="chart-canvas hidden"></canvas>
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 11px; color: var(--muted);">
                        <span id="chartInfo">Selecciona una gr√°fica para visualizar</span>
                    </div>
                    <button class="btn btn-secondary" id="exportChartBtn" style="padding: 4px 8px; font-size: 11px;" disabled>
                        <span>üñºÔ∏è</span> Exportar Gr√°fica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN =====
        const STORAGE_KEY = 'trading_suite_metrics_v2';
        let importedTrades = [];
        let calculatedMetrics = null;
        let currentChart = null;
        let currentChartType = 'distribution';
        
        // Variables para paginaci√≥n
        let currentPage = 1;
        let tradesPerPage = 20;

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Programa 2 - M√©tricas B√°sicas iniciado');
            
            // Cargar datos guardados si existen
            loadSavedData();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Configurar tabs de gr√°ficas
            setupChartTabs();
        });

        // ===== FUNCIONES DE IMPORTACI√ìN =====
        function setupEventListeners() {
            // Importaci√≥n JSON
            document.getElementById('importJsonInput').addEventListener('change', importFromJSON);
            
            // Importaci√≥n CSV
            document.getElementById('importCsvInput').addEventListener('change', importFromCSV);
            
            // Bot√≥n calcular m√©tricas
            document.getElementById('calculateMetricsBtn').addEventListener('click', calculateAllMetrics);
            
            // Bot√≥n generar gr√°ficas
            document.getElementById('generateChartsBtn').addEventListener('click', generateAllCharts);
            
            // Bot√≥n limpiar datos
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
            
            // Botones exportaci√≥n
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJSON);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
            
            // Bot√≥n exportar gr√°fica
            document.getElementById('exportChartBtn').addEventListener('click', exportChart);
            
            // Bot√≥n debug
            document.getElementById('debugBtn').addEventListener('click', debugData);
        }

        function setupChartTabs() {
            const tabs = document.querySelectorAll('.chart-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todos los tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // A√±adir clase active al tab clickeado
                    this.classList.add('active');
                    
                    // Cambiar gr√°fica
                    const chartType = this.dataset.chart;
                    currentChartType = chartType;
                    
                    if (calculatedMetrics && importedTrades.length > 0) {
                        renderChart(chartType);
                        updateChartInfo(chartType);
                    }
                });
            });
        }

        // ===== FUNCIONES DE CARGA Y GUARDADO =====
        function loadSavedData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    importedTrades = data.importedTrades || [];
                    calculatedMetrics = data.calculatedMetrics || null;
                    
                    updateDataStats();
                    updatePagination();
                    
                    if (importedTrades.length > 0) {
                        document.getElementById('calculateMetricsBtn').disabled = false;
                        if (calculatedMetrics) {
                            updateMetricsUI();
                            document.getElementById('exportJsonBtn').disabled = false;
                            document.getElementById('exportCsvBtn').disabled = false;
                            document.getElementById('generateChartsBtn').disabled = false;
                        }
                    }
                    
                    showNotification('Datos cargados desde almacenamiento local', 'info');
                }
            } catch (error) {
                console.warn('Error cargando datos guardados:', error);
            }
        }

        function saveToLocalStorage() {
            try {
                const data = {
                    importedTrades,
                    calculatedMetrics,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.warn('Error guardando datos:', error);
            }
        }

        // ===== FUNCIONES DE IMPORTACI√ìN DE DATOS =====
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Verificar formato del archivo
                    if (!data.trades && !Array.isArray(data)) {
                        throw new Error('Formato JSON inv√°lido. Debe contener un array "trades" o ser un array directo.');
                    }
                    
                    const trades = data.trades || data;
                    
                    if (!Array.isArray(trades)) {
                        throw new Error('Los datos deben ser un array de trades.');
                    }
                    
                    // Validar y normalizar trades
                    const normalizedTrades = trades.map(trade => ({
                        id: trade.id || Date.now() + Math.random(),
                        entryDate: trade.entryDate || trade.date || new Date().toISOString(),
                        instrument: trade.instrument || 'UNKNOWN',
                        direction: trade.direction || (trade.pnl >= 0 ? 'LONG' : 'SHORT'),
                        pnl: Number(trade.pnl) || 0,
                        pnlR: Number(trade.pnlR) || (trade.pnlR !== undefined ? trade.pnlR : 0),
                        size: Number(trade.size) || 1,
                        entryPrice: Number(trade.entryPrice) || 0,
                        exitPrice: Number(trade.exitPrice) || 0,
                        stopLoss: Number(trade.stopLoss) || 0,
                        takeProfit: Number(trade.takeProfit) || 0
                    }));
                    
                    importedTrades = normalizedTrades;
                    currentPage = 1; // Resetear a primera p√°gina
                    
                    // Actualizar UI
                    updateDataStats();
                    updatePagination();
                    document.getElementById('calculateMetricsBtn').disabled = false;
                    
                    // Limpiar m√©tricas previas
                    calculatedMetrics = null;
                    resetMetricsUI();
                    
                    saveToLocalStorage();
                    
                    showNotification(`${normalizedTrades.length} trades importados desde JSON`, 'success');
                    
                } catch (error) {
                    console.error('Error importing JSON:', error);
                    showNotification('Error importando JSON: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const trades = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const values = lines[i].split(',').map(v => v.trim());
                        const trade = {};
                        
                        headers.forEach((header, index) => {
                            if (index < values.length) {
                                let value = values[index];
                                
                                // Convertir a n√∫mero si es posible
                                if (!isNaN(value) && value !== '') {
                                    value = Number(value);
                                }
                                
                                trade[header] = value;
                            }
                        });
                        
                        // Normalizar nombres de campos
                        const normalizedTrade = {
                            id: trade.id || trade.ID || Date.now() + i,
                            entryDate: trade.entryDate || trade.date || trade.Date || new Date().toISOString(),
                            instrument: trade.instrument || trade.Instrument || 'UNKNOWN',
                            direction: trade.direction || trade.Direction || (trade.pnl >= 0 ? 'LONG' : 'SHORT'),
                            pnl: Number(trade.pnl || trade.PnL || trade.PNL || 0),
                            pnlR: Number(trade.pnlR || trade.PnLR || 0),
                            size: Number(trade.size || trade.Size || 1),
                            entryPrice: Number(trade.entryPrice || trade.entry || 0),
                            exitPrice: Number(trade.exitPrice || trade.exit || 0),
                            stopLoss: Number(trade.stopLoss || trade.sl || 0),
                            takeProfit: Number(trade.takeProfit || trade.tp || 0)
                        };
                        
                        trades.push(normalizedTrade);
                    }
                    
                    importedTrades = trades;
                    currentPage = 1; // Resetear a primera p√°gina
                    
                    // Actualizar UI
                    updateDataStats();
                    updatePagination();
                    document.getElementById('calculateMetricsBtn').disabled = false;
                    
                    // Limpiar m√©tricas previas
                    calculatedMetrics = null;
                    resetMetricsUI();
                    
                    saveToLocalStorage();
                    
                    showNotification(`${trades.length} trades importados desde CSV`, 'success');
                    
                } catch (error) {
                    console.error('Error importing CSV:', error);
                    showNotification('Error importando CSV: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // ===== FUNCIONES DE C√ÅLCULO B√ÅSICAS =====
        function calculateExpectancy(trades) {
            const rMultiples = trades.filter(t => !isNaN(t.pnlR)).map(t => t.pnlR);
            return rMultiples.length > 0 ? 
                rMultiples.reduce((a, b) => a + b, 0) / rMultiples.length : 0;
        }

        function calculatePayoffRatio(trades) {
            const winningTrades = trades.filter(t => t.pnl > 0);
            const losingTrades = trades.filter(t => t.pnl < 0);
            
            const avgWin = winningTrades.length > 0 ? 
                winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? 
                Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length) : 0;
            
            return avgLoss > 0 ? avgWin / avgLoss : avgWin > 0 ? Infinity : 0;
        }

        function calculateAvgWinLossRatio(trades) {
            const winningTrades = trades.filter(t => t.pnl > 0);
            const losingTrades = trades.filter(t => t.pnl < 0);
            
            const avgWin = winningTrades.length > 0 ? 
                winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? 
                Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length) : 0;
            
            return avgLoss > 0 ? avgWin / avgLoss : avgWin > 0 ? Infinity : 0;
        }

        function calculateBestTrade(trades) {
            if (trades.length === 0) return { value: 0, date: null };
            
            const best = trades.reduce((max, trade) => 
                trade.pnlR > max.pnlR ? trade : max
            , trades[0]);
            
            return {
                value: best.pnlR || 0,
                date: best.entryDate
            };
        }

        function calculateWorstTrade(trades) {
            if (trades.length === 0) return { value: 0, date: null };
            
            const worst = trades.reduce((min, trade) => 
                trade.pnlR < min.pnlR ? trade : min
            , trades[0]);
            
            return {
                value: worst.pnlR || 0,
                date: worst.entryDate
            };
        }

        function calculateMaxDrawdown(trades) {
            if (trades.length === 0) return 0;
            
            const sortedTrades = [...trades].sort((a, b) => 
                new Date(a.entryDate) - new Date(b.entryDate)
            );
            
            let cumulative = 0;
            let peak = 0;
            let maxDrawdown = 0;
            
            sortedTrades.forEach(trade => {
                cumulative += trade.pnl;
                peak = Math.max(peak, cumulative);
                const drawdown = peak - cumulative;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            });
            
            // Convertir a porcentaje basado en el peak
            return peak > 0 ? (maxDrawdown / peak * 100) : 0;
        }

        function calculateStreaks(trades) {
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;
            let winStreaks = [];
            let lossStreaks = [];
            
            const sortedTrades = [...trades].sort((a, b) => 
                new Date(a.entryDate) - new Date(b.entryDate)
            );
            
            sortedTrades.forEach(trade => {
                if (trade.pnl > 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else if (trade.pnl < 0) {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                } else {
                    // Break even, reiniciar ambas rachas
                    if (currentWinStreak > 0) winStreaks.push(currentWinStreak);
                    if (currentLossStreak > 0) lossStreaks.push(currentLossStreak);
                    currentWinStreak = 0;
                    currentLossStreak = 0;
                }
            });
            
            // A√±adir la √∫ltima racha
            if (currentWinStreak > 0) winStreaks.push(currentWinStreak);
            if (currentLossStreak > 0) lossStreaks.push(currentLossStreak);
            
            const avgWinStreak = winStreaks.length > 0 ? 
                winStreaks.reduce((a, b) => a + b, 0) / winStreaks.length : 0;
            const avgLossStreak = lossStreaks.length > 0 ? 
                lossStreaks.reduce((a, b) => a + b, 0) / lossStreaks.length : 0;
            
            return {
                maxWinStreak,
                maxLossStreak,
                avgWinStreak,
                avgLossStreak,
                winStreaks,
                lossStreaks
            };
        }

        function calculateMedian(values) {
            if (values.length === 0) return 0;
            
            const sorted = [...values].sort((a, b) => a - b);
            const middle = Math.floor(sorted.length / 2);
            
            if (sorted.length % 2 === 0) {
                return (sorted[middle - 1] + sorted[middle]) / 2;
            } else {
                return sorted[middle];
            }
        }

        function calculateStdDev(values) {
            if (values.length === 0) return 0;
            
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squaredDiffs = values.map(value => Math.pow(value - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(variance);
        }

        // ===== C√ÅLCULO DE M√âTRICAS MEJORADO =====
        function calculateAllMetrics() {
            if (importedTrades.length === 0) {
                showNotification('No hay datos para calcular m√©tricas', 'warning');
                return;
            }
            
            try {
                // Ordenar trades por fecha
                const sortedTrades = [...importedTrades].sort((a, b) => 
                    new Date(a.entryDate) - new Date(b.entryDate)
                );
                
                // 1. M√©tricas Totales
                const totalTrades = sortedTrades.length;
                const winningTrades = sortedTrades.filter(t => t.pnl > 0);
                const losingTrades = sortedTrades.filter(t => t.pnl < 0);
                const breakevenTrades = sortedTrades.filter(t => t.pnl === 0);
                const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades * 100) : 0;
                
                // Profit Factor
                const totalWins = winningTrades.reduce((sum, t) => sum + Math.abs(t.pnl), 0);
                const totalLosses = losingTrades.reduce((sum, t) => sum + Math.abs(t.pnl), 0);
                const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? Infinity : 0;
                
                // Net Profit Ratio (nueva m√©trica)
                const totalInvestment = sortedTrades.reduce((sum, t) => sum + (t.size * t.entryPrice), 0);
                const netProfitRatio = totalInvestment > 0 ? 
                    (sortedTrades.reduce((sum, t) => sum + t.pnl, 0) / totalInvestment * 100) : 0;
                
                // 2. M√©tricas de Rendimiento
                const expectancy = calculateExpectancy(sortedTrades);
                const payoffRatio = calculatePayoffRatio(sortedTrades);
                const avgWinLossRatio = calculateAvgWinLossRatio(sortedTrades);
                
                // Recovery Factor (nueva m√©trica)
                const maxDrawdown = calculateMaxDrawdown(sortedTrades);
                const totalProfit = sortedTrades.reduce((sum, t) => sum + (t.pnl > 0 ? t.pnl : 0), 0);
                const recoveryFactor = maxDrawdown > 0 ? totalProfit / maxDrawdown : 0;
                
                // 3. Operaciones Extremas
                const bestTrade = calculateBestTrade(sortedTrades);
                const worstTrade = calculateWorstTrade(sortedTrades);
                const rangeR = bestTrade.value - worstTrade.value;
                
                // Consistency Score (nueva m√©trica)
                const consistency = calculateConsistency(sortedTrades);
                
                // 4. Gesti√≥n del Riesgo
                const streaks = calculateStreaks(sortedTrades);
                
                // Risk of Ruin (nueva m√©trica - simplificada)
                const riskOfRuin = calculateRiskOfRuin(sortedTrades);
                
                // 5. M√©tricas Adicionales (sin solapar con Programa 3)
                const monthlyPerformance = calculateMonthlyPerformance(sortedTrades);
                const instrumentPerformance = calculateInstrumentPerformance(sortedTrades);
                const winLossBySize = calculateWinLossBySize(sortedTrades);
                const timeAnalysis = calculateTimeAnalysis(sortedTrades);
                
                // Guardar m√©tricas calculadas
                calculatedMetrics = {
                    // B√°sicas (originales)
                    totalTrades,
                    winningTrades: winningTrades.length,
                    losingTrades: losingTrades.length,
                    breakevenTrades: breakevenTrades.length,
                    winRate,
                    profitFactor,
                    
                    // Nuevas m√©tricas b√°sicas
                    netProfitRatio,
                    recoveryFactor,
                    consistency,
                    riskOfRuin,
                    
                    // Rendimiento
                    expectancy,
                    payoffRatio,
                    avgWinLossRatio,
                    
                    // Extremas
                    bestTrade,
                    worstTrade,
                    rangeR,
                    
                    // Riesgo
                    maxDrawdown,
                    maxWinStreak: streaks.maxWinStreak,
                    maxLossStreak: streaks.maxLossStreak,
                    avgWinStreak: streaks.avgWinStreak,
                    avgLossStreak: streaks.avgLossStreak,
                    
                    // An√°lisis adicional (para gr√°ficas)
                    monthlyPerformance,
                    instrumentPerformance,
                    winLossBySize,
                    timeAnalysis,
                    
                    // Estad√≠sticas
                    totalPnL: sortedTrades.reduce((sum, t) => sum + t.pnl, 0),
                    avgPnL: totalTrades > 0 ? sortedTrades.reduce((sum, t) => sum + t.pnl, 0) / totalTrades : 0,
                    avgWin: winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0,
                    avgLoss: losingTrades.length > 0 ? losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length : 0,
                    medianPnL: calculateMedian(sortedTrades.map(t => t.pnl)),
                    stdDevPnL: calculateStdDev(sortedTrades.map(t => t.pnl)),
                    
                    // Distribuciones para gr√°ficas
                    pnlDistribution: getPnLDistribution(sortedTrades),
                    rMultipleDistribution: getRMultipleDistribution(sortedTrades),
                    
                    // Metadata
                    calculationDate: new Date().toISOString(),
                    dataRange: {
                        start: sortedTrades.length > 0 ? sortedTrades[0].entryDate : null,
                        end: sortedTrades.length > 0 ? sortedTrades[sortedTrades.length - 1].entryDate : null
                    },
                    instruments: [...new Set(sortedTrades.map(t => t.instrument))],
                    sampleTrades: sortedTrades.slice(0, 5)
                };
                
                // Actualizar UI
                updateMetricsUI();
                updateDataStats();
                saveToLocalStorage();
                
                // Habilitar botones
                document.getElementById('exportJsonBtn').disabled = false;
                document.getElementById('exportCsvBtn').disabled = false;
                document.getElementById('generateChartsBtn').disabled = false;
                
                showNotification(`${totalTrades} trades analizados - ${calculatedMetrics.winRate.toFixed(1)}% Win Rate`, 'success');
                
            } catch (error) {
                console.error('Error calculating metrics:', error);
                showNotification('Error calculando m√©tricas: ' + error.message, 'error');
            }
        }

        // ===== NUEVAS M√âTRICAS COMPLEMENTARIAS =====
        function calculateConsistency(trades) {
            if (trades.length < 2) return 0;
            
            const pnls = trades.map(t => t.pnl);
            const positiveMonths = countPositiveMonths(trades);
            const totalMonths = getTradingMonths(trades);
            
            if (totalMonths === 0) return 0;
            
            // Ponderar: 60% meses positivos, 40% desviaci√≥n est√°ndar normalizada
            const monthConsistency = (positiveMonths / totalMonths) * 100 * 0.6;
            const stdDev = calculateStdDev(pnls);
            const avgPnL = pnls.reduce((a, b) => a + b, 0) / pnls.length;
            const volatilityScore = avgPnL !== 0 ? Math.max(0, 100 - (stdDev / Math.abs(avgPnL) * 100)) : 0;
            const volatilityConsistency = volatilityScore * 0.4;
            
            return monthConsistency + volatilityConsistency;
        }

        function calculateRiskOfRuin(trades) {
            if (trades.length === 0) return 0;
            
            const winRate = trades.filter(t => t.pnl > 0).length / trades.length;
            const avgWin = calculateAverageWin(trades);
            const avgLoss = calculateAverageLoss(trades);
            
            if (avgLoss === 0) return 0;
            
            // F√≥rmula simplificada de riesgo de ruina
            const riskPerTrade = Math.abs(avgLoss) / (Math.abs(avgLoss) + avgWin);
            const riskOfRuin = Math.pow(riskPerTrade, 10) * 100; // Para 10 trades consecutivos
            
            return Math.min(riskOfRuin, 100);
        }

        function calculateMonthlyPerformance(trades) {
            const monthlyData = {};
            
            trades.forEach(trade => {
                try {
                    const date = new Date(trade.entryDate);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            trades: 0,
                            wins: 0,
                            losses: 0,
                            pnl: 0,
                            winRate: 0
                        };
                    }
                    
                    monthlyData[monthKey].trades++;
                    monthlyData[monthKey].pnl += trade.pnl;
                    
                    if (trade.pnl > 0) {
                        monthlyData[monthKey].wins++;
                    } else if (trade.pnl < 0) {
                        monthlyData[monthKey].losses++;
                    }
                    
                    monthlyData[monthKey].winRate = monthlyData[monthKey].wins / monthlyData[monthKey].trades * 100;
                } catch (e) {
                    console.warn('Error processing trade date:', trade.entryDate);
                }
            });
            
            return monthlyData;
        }

        function calculateInstrumentPerformance(trades) {
            const instrumentData = {};
            
            trades.forEach(trade => {
                const instrument = trade.instrument || 'Unknown';
                
                if (!instrumentData[instrument]) {
                    instrumentData[instrument] = {
                        trades: 0,
                        wins: 0,
                        losses: 0,
                        pnl: 0,
                        winRate: 0
                    };
                }
                
                instrumentData[instrument].trades++;
                instrumentData[instrument].pnl += trade.pnl;
                
                if (trade.pnl > 0) {
                    instrumentData[instrument].wins++;
                } else if (trade.pnl < 0) {
                    instrumentData[instrument].losses++;
                }
                
                instrumentData[instrument].winRate = instrumentData[instrument].wins / instrumentData[instrument].trades * 100;
            });
            
            return instrumentData;
        }

        function calculateWinLossBySize(trades) {
            const sizeBins = {
                'small': { min: 0, max: 0.5, trades: 0, wins: 0, pnl: 0 },
                'medium': { min: 0.5, max: 2, trades: 0, wins: 0, pnl: 0 },
                'large': { min: 2, max: Infinity, trades: 0, wins: 0, pnl: 0 }
            };
            
            trades.forEach(trade => {
                const size = trade.size || 1;
                let bin = 'medium';
                
                if (size <= 0.5) bin = 'small';
                else if (size > 2) bin = 'large';
                
                sizeBins[bin].trades++;
                sizeBins[bin].pnl += trade.pnl;
                
                if (trade.pnl > 0) {
                    sizeBins[bin].wins++;
                }
            });
            
            return sizeBins;
        }

        function calculateTimeAnalysis(trades) {
            const timeData = {
                byHour: Array(24).fill().map(() => ({ trades: 0, wins: 0, pnl: 0 })),
                byWeekday: Array(7).fill().map(() => ({ trades: 0, wins: 0, pnl: 0 }))
            };
            
            trades.forEach(trade => {
                try {
                    const date = new Date(trade.entryDate);
                    const hour = date.getHours();
                    const weekday = date.getDay(); // 0 = Domingo, 6 = S√°bado
                    
                    timeData.byHour[hour].trades++;
                    timeData.byHour[hour].pnl += trade.pnl;
                    if (trade.pnl > 0) timeData.byHour[hour].wins++;
                    
                    timeData.byWeekday[weekday].trades++;
                    timeData.byWeekday[weekday].pnl += trade.pnl;
                    if (trade.pnl > 0) timeData.byWeekday[weekday].wins++;
                } catch (e) {
                    // Ignorar errores de fecha
                }
            });
            
            return timeData;
        }

        function getPnLDistribution(trades) {
            const bins = 10;
            const pnls = trades.map(t => t.pnl);
            const min = Math.min(...pnls);
            const max = Math.max(...pnls);
            const range = max - min;
            const binSize = range / bins;
            
            const distribution = Array(bins).fill().map(() => ({ count: 0, total: 0 }));
            
            trades.forEach(trade => {
                const binIndex = Math.min(Math.floor((trade.pnl - min) / binSize), bins - 1);
                distribution[binIndex].count++;
                distribution[binIndex].total += trade.pnl;
            });
            
            return {
                bins: distribution,
                min,
                max,
                binSize
            };
        }

        function getRMultipleDistribution(trades) {
            const validRTrades = trades.filter(t => !isNaN(t.pnlR));
            if (validRTrades.length === 0) return null;
            
            const rMultiples = validRTrades.map(t => t.pnlR);
            const min = Math.min(...rMultiples);
            const max = Math.max(...rMultiples);
            
            // Crear bins centrados en 0
            const bins = 15;
            const range = Math.max(Math.abs(min), Math.abs(max)) * 2;
            const binSize = range / bins;
            
            const distribution = Array(bins).fill().map(() => ({ count: 0, total: 0 }));
            
            validRTrades.forEach(trade => {
                const normalized = trade.pnlR + range/2;
                const binIndex = Math.min(Math.floor(normalized / binSize), bins - 1);
                distribution[binIndex].count++;
                distribution[binIndex].total += trade.pnlR;
            });
            
            return {
                bins: distribution,
                min,
                max,
                binSize
            };
        }

        // ===== FUNCIONES AUXILIARES =====
        function countPositiveMonths(trades) {
            const monthlyPnL = {};
            
            trades.forEach(trade => {
                try {
                    const date = new Date(trade.entryDate);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyPnL[monthKey]) {
                        monthlyPnL[monthKey] = 0;
                    }
                    
                    monthlyPnL[monthKey] += trade.pnl;
                } catch (e) {
                    // Ignorar errores de fecha
                }
            });
            
            let positiveMonths = 0;
            Object.values(monthlyPnL).forEach(pnl => {
                if (pnl > 0) positiveMonths++;
            });
            
            return positiveMonths;
        }

        function getTradingMonths(trades) {
            const months = new Set();
            
            trades.forEach(trade => {
                try {
                    const date = new Date(trade.entryDate);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    months.add(monthKey);
                } catch (e) {
                    // Ignorar errores de fecha
                }
            });
            
            return months.size;
        }

        function calculateAverageWin(trades) {
            const winningTrades = trades.filter(t => t.pnl > 0);
            return winningTrades.length > 0 ? 
                winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
        }

        function calculateAverageLoss(trades) {
            const losingTrades = trades.filter(t => t.pnl < 0);
            return losingTrades.length > 0 ? 
                losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length : 0;
        }

        // ===== PAGINACI√ìN =====
        function updatePagination() {
            const totalPages = Math.ceil(importedTrades.length / tradesPerPage);
            
            // Crear o actualizar controles de paginaci√≥n
            const tableContainer = document.querySelector('.data-table-container');
            let paginationContainer = tableContainer.querySelector('.pagination-controls');
            
            if (!paginationContainer) {
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination-controls';
                tableContainer.appendChild(paginationContainer);
            }
            
            // Actualizar contenido de paginaci√≥n
            const pageStart = (currentPage - 1) * tradesPerPage + 1;
            const pageEnd = Math.min(currentPage * tradesPerPage, importedTrades.length);
            
            paginationContainer.innerHTML = `
                <div style="font-size: 12px; color: var(--muted);">
                    Mostrando <span id="pageStart">${pageStart}</span>-<span id="pageEnd">${pageEnd}</span> de ${importedTrades.length} trades
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <button id="prevPageBtn" class="btn-pagination" ${currentPage === 1 ? 'disabled' : ''}>
                        ‚óÄ
                    </button>
                    <div id="pageNumbers" style="display: flex; gap: 3px;"></div>
                    <button id="nextPageBtn" class="btn-pagination" ${currentPage === totalPages ? 'disabled' : ''}>
                        ‚ñ∂
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--muted);">
                    <select id="tradesPerPageSelect" style="background: var(--card-bg); color: var(--neon-cyan); border: var(--border-thin); border-radius: 4px; padding: 2px 5px;">
                        <option value="10" ${tradesPerPage === 10 ? 'selected' : ''}>10 por p√°gina</option>
                        <option value="20" ${tradesPerPage === 20 ? 'selected' : ''}>20 por p√°gina</option>
                        <option value="50" ${tradesPerPage === 50 ? 'selected' : ''}>50 por p√°gina</option>
                        <option value="100" ${tradesPerPage === 100 ? 'selected' : ''}>100 por p√°gina</option>
                    </select>
                </div>
            `;
            
            // Actualizar n√∫meros de p√°gina
            updatePageNumbers();
            
            // Configurar event listeners
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updatePagination();
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePagination();
                }
            });
            
            document.getElementById('tradesPerPageSelect').addEventListener('change', (e) => {
                tradesPerPage = parseInt(e.target.value);
                currentPage = 1;
                updatePagination();
            });
            
            // Actualizar tabla
            updateTable();
        }

        function updatePageNumbers() {
            const totalPages = Math.ceil(importedTrades.length / tradesPerPage);
            const pageNumbersContainer = document.getElementById('pageNumbers');
            
            if (!pageNumbersContainer) return;
            
            pageNumbersContainer.innerHTML = '';
            
            // Mostrar m√°ximo 5 n√∫meros de p√°gina
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Ajustar si estamos cerca del final
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // Primera p√°gina
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'page-number';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    currentPage = 1;
                    updatePagination();
                });
                pageNumbersContainer.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.color = 'var(--muted)';
                    ellipsis.style.padding = '4px 2px';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }
            
            // P√°ginas numeradas
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    updatePagination();
                });
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // √öltima p√°gina
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.color = 'var(--muted)';
                    ellipsis.style.padding = '4px 2px';
                    pageNumbersContainer.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'page-number';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    currentPage = totalPages;
                    updatePagination();
                });
                pageNumbersContainer.appendChild(lastPageBtn);
            }
        }

        // ===== GR√ÅFICAS (CORREGIDAS PARA EVITAR SCROLL) =====
        function generateAllCharts() {
            if (!calculatedMetrics || importedTrades.length === 0) {
                showNotification('Calcula las m√©tricas primero', 'warning');
                return;
            }
            
            try {
                // Destruir gr√°fica anterior si existe
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                
                // Obtener dimensiones del contenedor
                const chartWrapper = document.querySelector('.chart-wrapper');
                const canvas = document.getElementById('metricsChart');
                
                // Establecer dimensiones fijas
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.width = chartWrapper.clientWidth;
                canvas.height = chartWrapper.clientHeight;
                
                // Mostrar canvas y ocultar placeholder
                document.getElementById('chartPlaceholder').classList.add('hidden');
                document.getElementById('metricsChart').classList.remove('hidden');
                document.getElementById('exportChartBtn').disabled = false;
                
                // Peque√±a pausa para asegurar que el DOM se actualiz√≥
                setTimeout(() => {
                    renderChart(currentChartType);
                    updateChartInfo(currentChartType);
                    showNotification('Gr√°ficas generadas exitosamente', 'success');
                }, 50);
                
            } catch (error) {
                console.error('Error generating charts:', error);
                showNotification('Error generando gr√°ficas', 'error');
            }
        }

        function renderChart(chartType) {
            if (!calculatedMetrics) return;
            
            const canvas = document.getElementById('metricsChart');
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fica anterior si existe
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            // Asegurar dimensiones v√°lidas
            if (canvas.width === 0 || canvas.height === 0) {
                const chartWrapper = document.querySelector('.chart-wrapper');
                canvas.width = chartWrapper.clientWidth;
                canvas.height = chartWrapper.clientHeight;
            }
            
            let chartConfig;
            
            switch(chartType) {
                case 'distribution':
                    chartConfig = createDistributionChart();
                    break;
                case 'winLoss':
                    chartConfig = createWinLossChart();
                    break;
                case 'streaks':
                    chartConfig = createStreaksChart();
                    break;
                case 'monthly':
                    chartConfig = createMonthlyChart();
                    break;
                case 'instruments':
                    chartConfig = createInstrumentsChart();
                    break;
                case 'equity':
                    chartConfig = createEquityChart();
                    break;
                default:
                    chartConfig = createDistributionChart();
            }
            
            // Configuraci√≥n anti-scroll infinito
            chartConfig.options.responsive = false;
            chartConfig.options.maintainAspectRatio = false;
            
            // Crear la gr√°fica
            currentChart = new Chart(ctx, chartConfig);
            
            // Forzar un resize despu√©s de un breve delay
            setTimeout(() => {
                if (currentChart) {
                    currentChart.resize();
                }
            }, 100);
        }

        function createDistributionChart() {
            const distribution = calculatedMetrics.pnlDistribution;
            const labels = distribution.bins.map((bin, i) => {
                const minVal = distribution.min + (i * distribution.binSize);
                return `$${minVal.toFixed(0)}`;
            });
            
            const data = distribution.bins.map(bin => bin.count);
            
            return {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N√∫mero de Trades',
                        data: data,
                        backgroundColor: 'rgba(0, 240, 255, 0.6)',
                        borderColor: 'rgba(0, 240, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#dfefff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribuci√≥n de PnL',
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 240, 255, 0.1)'
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 6
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#dfefff',
                                maxRotation: 0,
                                maxTicksLimit: 8
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function createWinLossChart() {
            const m = calculatedMetrics;
            const winLossData = [
                m.winningTrades,
                m.losingTrades,
                m.breakevenTrades || 0
            ];
            
            return {
                type: 'doughnut',
                data: {
                    labels: ['Ganadores', 'Perdedores', 'Break Even'],
                    datasets: [{
                        data: winLossData,
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.8)',
                            'rgba(255, 85, 85, 0.8)',
                            'rgba(0, 240, 255, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 255, 136, 1)',
                            'rgba(255, 85, 85, 1)',
                            'rgba(0, 240, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#dfefff',
                                padding: 10,
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Distribuci√≥n Win/Loss (${m.winRate.toFixed(1)}% Win Rate)`,
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function createStreaksChart() {
            const m = calculatedMetrics;
            
            return {
                type: 'bar',
                data: {
                    labels: ['Racha M√°x. Wins', 'Racha M√°x. Losses', 'Prom. Win Streak', 'Prom. Loss Streak'],
                    datasets: [{
                        label: 'Trades Consecutivos',
                        data: [
                            m.maxWinStreak,
                            m.maxLossStreak,
                            m.avgWinStreak || 0,
                            m.avgLossStreak || 0
                        ],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.8)',
                            'rgba(255, 85, 85, 0.8)',
                            'rgba(0, 240, 255, 0.8)',
                            'rgba(255, 255, 0, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 255, 136, 1)',
                            'rgba(255, 85, 85, 1)',
                            'rgba(0, 240, 255, 1)',
                            'rgba(255, 255, 0, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#dfefff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'An√°lisis de Rachas (Consecutivos)',
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 240, 255, 0.1)'
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 6
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 4
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function createMonthlyChart() {
            const monthly = calculatedMetrics.monthlyPerformance;
            const labels = Object.keys(monthly).sort();
            
            // Limitar a 8 meses
            const displayLabels = labels.slice(-8).map(label => {
                const [year, month] = label.split('-');
                return `${month}/${year.slice(2)}`;
            });
            const winRates = labels.slice(-8).map(label => monthly[label].winRate || 0);
            
            return {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: 'Win Rate (%)',
                        data: winRates,
                        borderColor: 'rgba(0, 240, 255, 1)',
                        backgroundColor: 'rgba(0, 240, 255, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#dfefff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Win Rate Mensual',
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: 'rgba(0, 240, 255, 0.1)'
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 6
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 8
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function createInstrumentsChart() {
            const instruments = calculatedMetrics.instrumentPerformance;
            const labels = Object.keys(instruments);
            
            // Limitar a 8 instrumentos
            const displayLabels = labels.slice(0, 8);
            const winRates = displayLabels.map(label => instruments[label].winRate || 0);
            
            return {
                type: 'radar',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: 'Win Rate por Instrumento (%)',
                        data: winRates,
                        backgroundColor: 'rgba(0, 240, 255, 0.2)',
                        borderColor: 'rgba(0, 240, 255, 1)',
                        pointBackgroundColor: 'rgba(0, 240, 255, 0.8)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(0, 240, 255, 1)'
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#dfefff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Performance por Instrumento',
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(0, 240, 255, 0.2)'
                            },
                            grid: {
                                color: 'rgba(0, 240, 255, 0.2)'
                            },
                            pointLabels: {
                                color: '#dfefff',
                                font: {
                                    size: 10
                                }
                            },
                            ticks: {
                                color: '#dfefff',
                                backdropColor: 'transparent',
                                maxTicksLimit: 5
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function createEquityChart() {
            const sortedTrades = [...importedTrades].sort((a, b) => 
                new Date(a.entryDate) - new Date(b.entryDate)
            );
            
            let cumulative = 0;
            const equityCurve = [];
            const dates = [];
            
            // Muestrear para evitar demasiados puntos
            const sampleRate = Math.max(1, Math.floor(sortedTrades.length / 40));
            
            for (let i = 0; i < sortedTrades.length; i += sampleRate) {
                cumulative += sortedTrades[i].pnl;
                equityCurve.push(cumulative);
                
                const date = new Date(sortedTrades[i].entryDate);
                dates.push(`${date.getDate()}/${date.getMonth()+1}`);
            }
            
            return {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Equity',
                        data: equityCurve,
                        borderColor: 'rgba(0, 255, 136, 1)',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#dfefff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Curva de Equity',
                            color: '#00f0ff',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: 'rgba(0, 240, 255, 0.1)'
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 6
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#dfefff',
                                maxTicksLimit: 8
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            };
        }

        function updateChartInfo(chartType) {
            const infoTexts = {
                'distribution': 'Distribuci√≥n de ganancias y p√©rdidas por tama√±o',
                'winLoss': 'Relaci√≥n entre trades ganadores y perdedores',
                'streaks': 'An√°lisis de rachas consecutivas de wins/losses',
                'monthly': 'Rendimiento mensual con win rate',
                'instruments': 'Comparativa de performance por instrumento',
                'equity': 'Evoluci√≥n del capital acumulado'
            };
            
            document.getElementById('chartInfo').textContent = infoTexts[chartType] || '';
        }

        function exportChart() {
            if (!currentChart) {
                showNotification('No hay gr√°fica para exportar', 'warning');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.download = `grafica_${currentChartType}_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = currentChart.toBase64Image();
                link.click();
                
                showNotification('Gr√°fica exportada como PNG', 'success');
            } catch (error) {
                console.error('Error exporting chart:', error);
                showNotification('Error exportando gr√°fica', 'error');
            }
        }

        // ===== FUNCIONES DE UI =====
        function updateTable() {
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';
            
            if (importedTrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                            Importa datos del Programa 1 para ver los trades
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar por fecha descendente
            const sortedTrades = [...importedTrades].sort((a, b) => 
                new Date(b.entryDate) - new Date(a.entryDate)
            );
            
            // Calcular √≠ndices para la p√°gina actual
            const startIndex = (currentPage - 1) * tradesPerPage;
            const endIndex = Math.min(startIndex + tradesPerPage, sortedTrades.length);
            const pageTrades = sortedTrades.slice(startIndex, endIndex);
            
            pageTrades.forEach((trade, index) => {
                const globalIndex = startIndex + index + 1;
                const row = document.createElement('tr');
                
                const pnl = trade.pnl || 0;
                const pnlR = trade.pnlR || 0;
                const resultClass = pnl > 0 ? 'badge-success' : pnl < 0 ? 'badge-danger' : 'badge-warning';
                const resultText = pnl > 0 ? 'WIN' : pnl < 0 ? 'LOSS' : 'BE';
                const directionClass = trade.direction === 'LONG' ? 'badge-info' : 'badge-warning';
                
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>${formatDateShort(trade.entryDate)}</td>
                    <td>${trade.instrument || 'N/A'}</td>
                    <td><span class="badge ${directionClass}">${trade.direction || 'N/A'}</span></td>
                    <td style="color: ${pnl >= 0 ? 'var(--neon-green)' : 'var(--neon-red)'}; font-weight: 600;">
                        $${pnl.toFixed(2)}
                    </td>
                    <td style="color: ${pnlR >= 0 ? 'var(--neon-green)' : 'var(--neon-red)'}; font-weight: 600;">
                        ${pnlR.toFixed(2)}R
                    </td>
                    <td><span class="badge ${resultClass}">${resultText}</span></td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('tableSummary').textContent = 
                `P√°gina ${currentPage} de ${Math.ceil(sortedTrades.length / tradesPerPage)}`;
        }

        function updateDataStats() {
            document.getElementById('loadedTradesCount').textContent = importedTrades.length;
            
            if (importedTrades.length > 0) {
                const dates = importedTrades.map(t => new Date(t.entryDate)).filter(d => !isNaN(d.getTime()));
                if (dates.length > 0) {
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));
                    document.getElementById('dataPeriod').textContent = 
                        `${formatDateShort(minDate)} - ${formatDateShort(maxDate)}`;
                } else {
                    document.getElementById('dataPeriod').textContent = 'Fecha inv√°lida';
                }
                
                document.getElementById('lastUpdate').textContent = formatDateTime(new Date());
                document.getElementById('dataStatus').textContent = 'Datos cargados';
                document.getElementById('dataStatus').style.color = 'var(--neon-green)';
            } else {
                document.getElementById('dataPeriod').textContent = 'N/A';
                document.getElementById('dataStatus').textContent = 'Esperando datos';
                document.getElementById('dataStatus').style.color = 'var(--neon-yellow)';
            }
        }

        function updateMetricsUI() {
            if (!calculatedMetrics) return;
            
            const m = calculatedMetrics;
            
            // 1. Totales (con nuevas m√©tricas)
            document.getElementById('metricTotalTrades').textContent = m.totalTrades;
            document.getElementById('metricWinRate').textContent = `${m.winRate.toFixed(1)}%`;
            document.getElementById('winRateBar').style.width = `${Math.min(m.winRate, 100)}%`;
            
            const pfValue = m.profitFactor === Infinity ? '‚àû' : m.profitFactor.toFixed(2);
            document.getElementById('metricProfitFactor').textContent = pfValue;
            document.getElementById('profitFactorRating').textContent = getProfitFactorRating(m.profitFactor);
            
            document.getElementById('metricNetProfitRatio').textContent = `${m.netProfitRatio.toFixed(2)}%`;
            
            // 2. Rendimiento (con nuevas m√©tricas)
            document.getElementById('metricExpectancy').textContent = m.expectancy.toFixed(2);
            document.getElementById('metricPayoffRatio').textContent = m.payoffRatio === Infinity ? '‚àû' : m.payoffRatio.toFixed(2);
            document.getElementById('metricWinLossRatio').textContent = m.avgWinLossRatio === Infinity ? '‚àû' : m.avgWinLossRatio.toFixed(2);
            document.getElementById('metricRecoveryFactor').textContent = m.recoveryFactor.toFixed(2);
            
            // 3. Extremas (con nuevas m√©tricas)
            document.getElementById('metricBestTrade').textContent = m.bestTrade.value.toFixed(2);
            document.getElementById('bestTradeInfo').textContent = m.bestTrade.date ? 
                `Fecha: ${formatDateShort(m.bestTrade.date)}` : 'Sin datos';
            
            document.getElementById('metricWorstTrade').textContent = m.worstTrade.value.toFixed(2);
            document.getElementById('worstTradeInfo').textContent = m.worstTrade.date ? 
                `Fecha: ${formatDateShort(m.worstTrade.date)}` : 'Sin datos';
            
            document.getElementById('metricRange').textContent = m.rangeR.toFixed(2);
            document.getElementById('metricConsistency').textContent = `${m.consistency.toFixed(1)}%`;
            
            // 4. Riesgo (con nuevas m√©tricas)
            document.getElementById('metricMaxDrawdown').textContent = `${m.maxDrawdown.toFixed(2)}%`;
            document.getElementById('drawdownInfo').textContent = `M√°xima ca√≠da ${m.maxDrawdown.toFixed(1)}%`;
            document.getElementById('metricMaxWinStreak').textContent = m.maxWinStreak;
            document.getElementById('metricMaxLossStreak').textContent = m.maxLossStreak;
            document.getElementById('metricRiskOfRuin').textContent = `${m.riskOfRuin.toFixed(2)}%`;
            
            // Actualizar estado
            document.getElementById('metricsStatus').textContent = `(${m.totalTrades} trades - ${m.winRate.toFixed(1)}% WR)`;
            document.getElementById('calculationTime').textContent = `√öltimo c√°lculo: ${formatDateTime(new Date())}`;
            
            // Actualizar colores seg√∫n valores
            updateMetricColors();
        }

        function resetMetricsUI() {
            // Resetear todos los valores a cero
            document.getElementById('metricTotalTrades').textContent = '0';
            document.getElementById('metricWinRate').textContent = '0%';
            document.getElementById('winRateBar').style.width = '0%';
            document.getElementById('metricProfitFactor').textContent = '0.00';
            document.getElementById('profitFactorRating').textContent = '(Sin datos)';
            document.getElementById('metricNetProfitRatio').textContent = '0.00';
            
            document.getElementById('metricExpectancy').textContent = '0.00';
            document.getElementById('metricPayoffRatio').textContent = '0.00';
            document.getElementById('metricWinLossRatio').textContent = '0.00';
            document.getElementById('metricRecoveryFactor').textContent = '0.00';
            
            document.getElementById('metricBestTrade').textContent = '0.00';
            document.getElementById('bestTradeInfo').textContent = 'Fecha: N/A';
            document.getElementById('metricWorstTrade').textContent = '0.00';
            document.getElementById('worstTradeInfo').textContent = 'Fecha: N/A';
            document.getElementById('metricRange').textContent = '0.00';
            document.getElementById('metricConsistency').textContent = '0.00';
            
            document.getElementById('metricMaxDrawdown').textContent = '0.00%';
            document.getElementById('drawdownInfo').textContent = 'M√°xima ca√≠da';
            document.getElementById('metricMaxWinStreak').textContent = '0';
            document.getElementById('metricMaxLossStreak').textContent = '0';
            document.getElementById('metricRiskOfRuin').textContent = '0.00%';
            
            document.getElementById('metricsStatus').textContent = '(Sin datos)';
            document.getElementById('calculationTime').textContent = '√öltimo c√°lculo: N/A';
        }

        function updateMetricColors() {
            // Actualizar colores seg√∫n valores
            const profitFactor = calculatedMetrics.profitFactor;
            const pfElement = document.getElementById('metricProfitFactor');
            if (profitFactor === Infinity || profitFactor >= 2) {
                pfElement.className = 'metric-value positive';
            } else if (profitFactor >= 1.5) {
                pfElement.className = 'metric-value neutral';
            } else if (profitFactor >= 1) {
                pfElement.className = 'metric-value negative';
            } else {
                pfElement.className = 'metric-value negative';
            }
        }

        function getProfitFactorRating(pf) {
            if (pf === Infinity) return '(Excelente)';
            if (pf >= 2) return '(Excelente)';
            if (pf >= 1.5) return '(Bueno)';
            if (pf >= 1.2) return '(Aceptable)';
            if (pf >= 1) return '(M√≠nimo)';
            return '(P√©rdida)';
        }

        // ===== FUNCIONES DE EXPORTACI√ìN =====
        function exportToJSON() {
            if (!calculatedMetrics) {
                showNotification('No hay m√©tricas para exportar', 'warning');
                return;
            }
            
            try {
                const exportData = {
                    metadata: {
                        program: 'TRADING SUITE - Programa 2',
                        version: '2.0',
                        exportDate: new Date().toISOString(),
                        dataPoints: importedTrades.length
                    },
                    trades: importedTrades,
                    metrics: calculatedMetrics
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `trading_metrics_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                showNotification('M√©tricas exportadas a JSON', 'success');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                showNotification('Error exportando JSON', 'error');
            }
        }

        function exportToCSV() {
            if (!calculatedMetrics || importedTrades.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                // Crear CSV con trades y m√©tricas
                let csvContent = 'TRADING SUITE - M√©tricas B√°sicas\n\n';
                
                // Secci√≥n de m√©tricas
                csvContent += 'M√âTRICAS B√ÅSICAS\n';
                csvContent += 'M√©trica,Valor\n';
                csvContent += `Total Trades,${calculatedMetrics.totalTrades}\n`;
                csvContent += `Win Rate,${calculatedMetrics.winRate.toFixed(2)}%\n`;
                csvContent += `Profit Factor,${calculatedMetrics.profitFactor === Infinity ? 'Infinity' : calculatedMetrics.profitFactor.toFixed(2)}\n`;
                csvContent += `Expectancy,${calculatedMetrics.expectancy.toFixed(2)}\n`;
                csvContent += `Payoff Ratio,${calculatedMetrics.payoffRatio === Infinity ? 'Infinity' : calculatedMetrics.payoffRatio.toFixed(2)}\n`;
                csvContent += `Max Drawdown,${calculatedMetrics.maxDrawdown.toFixed(2)}%\n`;
                csvContent += `Consistencia,${calculatedMetrics.consistency.toFixed(2)}%\n`;
                csvContent += `Risk of Ruin,${calculatedMetrics.riskOfRuin.toFixed(2)}%\n\n`;
                
                // Secci√≥n de trades
                csvContent += 'TRADES DETALLADOS\n';
                csvContent += 'Fecha,Instrumento,Direcci√≥n,PnL ($),PnL (R),Resultado\n';
                
                importedTrades.forEach(trade => {
                    const pnl = trade.pnl || 0;
                    const result = pnl > 0 ? 'WIN' : pnl < 0 ? 'LOSS' : 'BE';
                    csvContent += `${trade.entryDate},${trade.instrument || 'N/A'},${trade.direction || 'N/A'},${pnl.toFixed(2)},${(trade.pnlR || 0).toFixed(2)},${result}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `trading_data_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                showNotification('Datos exportados a CSV', 'success');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showNotification('Error exportando CSV', 'error');
            }
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos?')) {
                importedTrades = [];
                calculatedMetrics = null;
                currentPage = 1;
                
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                
                // Resetear UI
                updateDataStats();
                updatePagination();
                resetMetricsUI();
                
                // Deshabilitar botones
                document.getElementById('calculateMetricsBtn').disabled = true;
                document.getElementById('exportJsonBtn').disabled = true;
                document.getElementById('exportCsvBtn').disabled = true;
                document.getElementById('generateChartsBtn').disabled = true;
                document.getElementById('exportChartBtn').disabled = true;
                
                // Mostrar placeholder de gr√°fica
                document.getElementById('chartPlaceholder').classList.remove('hidden');
                document.getElementById('metricsChart').classList.add('hidden');
                
                // Limpiar almacenamiento
                localStorage.removeItem(STORAGE_KEY);
                
                showNotification('Todos los datos han sido eliminados', 'info');
            }
        }

        function debugData() {
            console.log('=== DEBUG INFO ===');
            console.log('Imported Trades:', importedTrades);
            console.log('Calculated Metrics:', calculatedMetrics);
            console.log('Current Chart:', currentChart);
            console.log('Current Page:', currentPage);
            console.log('Trades per Page:', tradesPerPage);
            console.log('==================');
            
            showNotification('Informaci√≥n de depuraci√≥n mostrada en consola', 'info');
        }

        function showNotification(message, type = 'info') {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                border: 1px solid;
            `;
            
            const colors = {
                success: { bg: 'rgba(0, 255, 136, 0.9)', border: 'rgba(0, 255, 136, 0.5)' },
                error: { bg: 'rgba(255, 85, 85, 0.9)', border: 'rgba(255, 85, 85, 0.5)' },
                warning: { bg: 'rgba(255, 255, 0, 0.9)', border: 'rgba(255, 255, 0, 0.5)', color: '#000' },
                info: { bg: 'rgba(0, 240, 255, 0.9)', border: 'rgba(0, 240, 255, 0.5)' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.background = color.bg;
            notification.style.borderColor = color.border;
            if (color.color) notification.style.color = color.color;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // A√±adir estilos CSS para animaciones si no existen
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function formatDateShort(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return 'Fecha inv√°lida';
            }
        }

        function formatDateTime(date) {
            return date.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) + ' ' + formatDateShort(date);
        }
    </script>
</body>
</html>