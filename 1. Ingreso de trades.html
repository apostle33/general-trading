<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRADING SUITE | Programa 1 - Gesti√≥n de Trades</title>
    <style>
        /* ===== ESTILOS CYBERPUNK BASE ===== */
        :root {
            --bg-1: #06060a;
            --bg-2: #0b0011;
            --neon-cyan: #00f0ff;
            --neon-blue: #6f5cff;
            --neon-magenta: #ff4cff;
            --neon-green: #00ff88;
            --neon-red: #ff5555;
            --neon-yellow: #ffff00;
            --muted: rgba(230, 238, 248, 0.55);
            --card-bg: rgba(20, 20, 40, 0.85);
            --glow-cyan: 0 0 10px rgba(0, 240, 255, 0.5);
            --glow-green: 0 0 10px rgba(0, 255, 136, 0.5);
            --glow-red: 0 0 10px rgba(255, 85, 85, 0.5);
            --radius: 8px;
            --border-thin: 1px solid rgba(0, 240, 255, 0.2);
            font-family: 'Segoe UI', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-1);
            color: #dfefff;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: var(--border-thin);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: var(--glow-cyan);
            letter-spacing: 1px;
        }

        .program-indicator {
            background: rgba(0, 240, 255, 0.1);
            padding: 5px 15px;
            border-radius: var(--radius);
            border: var(--border-thin);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* ===== FORMULARIO DE TRADES ===== */
        .form-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
        }

        .form-title {
            color: var(--neon-cyan);
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: var(--border-thin);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select, .form-textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 4px;
            padding: 8px 12px;
            color: #dfefff;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .form-textarea {
            grid-column: 1 / -1;
            min-height: 80px;
            resize: vertical;
        }

        /* Botones del formulario */
        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: var(--border-thin);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-blue));
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--neon-cyan);
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        .btn-danger {
            background: rgba(255, 85, 85, 0.1);
            color: var(--neon-red);
            border: 1px solid rgba(255, 85, 85, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ===== TABLA DE TRADES ===== */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: var(--border-thin);
        }

        .table-title {
            color: var(--neon-cyan);
            font-size: 18px;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            background: rgba(0, 0, 0, 0.3);
            border: var(--border-thin);
            border-radius: 4px;
            padding: 6px 12px;
            color: #dfefff;
            width: 200px;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
        }

        .filter-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 4px;
            color: var(--muted);
            cursor: pointer;
        }

        .filter-btn.active {
            background: rgba(0, 240, 255, 0.1);
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
        }

        /* Tabla principal */
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            flex: 1;
            min-height: 300px;
        }

        .trades-table th {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--neon-cyan);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: var(--border-thin);
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .trades-table th:hover {
            background: rgba(0, 240, 255, 0.1);
        }

        .trades-table th.sort-asc::after {
            content: " ‚Üë";
            color: var(--neon-green);
        }

        .trades-table th.sort-desc::after {
            content: " ‚Üì";
            color: var(--neon-red);
        }

        .trades-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.05);
            font-size: 13px;
        }

        .trades-table tr:hover {
            background: rgba(0, 240, 255, 0.05);
        }

        /* Colores condicionales */
        .pnl-positive {
            color: var(--neon-green);
            font-weight: 600;
        }

        .pnl-negative {
            color: var(--neon-red);
            font-weight: 600;
        }

        .direction-buy {
            color: var(--neon-green);
        }

        .direction-sell {
            color: var(--neon-red);
        }

        /* Acciones de la tabla */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            color: var(--muted);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .edit-btn:hover {
            color: var(--neon-cyan);
            background: rgba(0, 240, 255, 0.1);
        }

        .delete-btn:hover {
            color: var(--neon-red);
            background: rgba(255, 85, 85, 0.1);
        }

        .duplicate-btn:hover {
            color: var(--neon-yellow);
            background: rgba(255, 255, 0, 0.1);
        }

        /* ===== PANEL INFERIOR ===== */
        .bottom-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .bottom-panel {
                grid-template-columns: 1fr;
            }
        }

        /* Estad√≠sticas */
        .stats-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
        }

        .stats-title {
            color: var(--neon-cyan);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--neon-green);
        }

        .stat-value.negative {
            color: var(--neon-red);
        }

        /* Importaci√≥n/Exportaci√≥n */
        .io-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            border: var(--border-thin);
            backdrop-filter: blur(5px);
        }

        .io-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .io-btn {
            flex: 1;
            min-width: 120px;
        }

        .file-input {
            display: none;
        }

        /* ===== UTILITIES ===== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Modal de recuperaci√≥n */
        .recovery-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .recovery-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            border: 2px solid var(--neon-red);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(255, 85, 85, 0.3);
        }

        .recovery-title {
            color: var(--neon-red);
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recovery-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-magenta));
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Modal de recuperaci√≥n (oculto por defecto) -->
    <div id="recoveryModal" class="recovery-modal hidden">
        <div class="recovery-content">
            <div class="recovery-title">
                <span>‚ö†Ô∏è</span> DATOS CORRUPTOS DETECTADOS
            </div>
            <p style="margin-bottom: 15px; color: var(--muted);">
                Se detectaron datos corruptos en el almacenamiento local. Esto puede causar que la aplicaci√≥n se congele o funcione incorrectamente.
            </p>
            <p style="margin-bottom: 20px; font-size: 14px; color: var(--neon-yellow);">
                <strong>Causas posibles:</strong> Archivos importados inv√°lidos, datos malformados, o corrupci√≥n del navegador.
            </p>
            <div class="recovery-buttons">
                <button id="repairDataBtn" class="btn btn-primary">
                    üîß Reparar Datos
                </button>
                <button id="resetDataBtn" class="btn btn-danger">
                    üóëÔ∏è Resetear Todo
                </button>
                <button id="ignoreBtn" class="btn btn-secondary">
                    ‚è≠Ô∏è Ignorar
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div style="width: 40px; height: 40px; border-radius: 6px; background: linear-gradient(45deg, var(--neon-cyan), var(--neon-magenta));"></div>
                <div>
                    <h1>TRADING SUITE</h1>
                    <div style="font-size: 12px; color: var(--muted);">Professional Trading Analytics</div>
                </div>
            </div>
            <div class="program-indicator">
                PROGRAMA 1: <strong style="color: var(--neon-cyan);">Gesti√≥n de Trades</strong>
                <button id="dataManagerBtn" class="debug-btn">
                    üõ†Ô∏è Gestor de Datos
                </button>
                <button id="debugBtn" class="debug-btn">
                    üêõ Debug
                </button>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Formulario de Entrada -->
            <div class="form-container">
                <div class="form-title">
                    <span>üìù NUEVO TRADE</span>
                    <span id="formModeIndicator" style="font-size: 12px; color: var(--neon-yellow);">Modo: Creaci√≥n</span>
                </div>
                
                <div class="form-grid">
                    <!-- Fechas -->
                    <div class="form-group">
                        <label class="form-label">Fecha Entrada</label>
                        <input type="datetime-local" class="form-input" id="entryDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha Salida</label>
                        <input type="datetime-local" class="form-input" id="exitDate">
                    </div>

                    <!-- Instrumento y Setup -->
                    <div class="form-group">
                        <label class="form-label">Instrumento</label>
                        <input type="text" class="form-input" id="instrument" placeholder="EURUSD, BTCUSD, etc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Setup / Estrategia</label>
                        <input type="text" class="form-input" id="strategy" placeholder="Scalping, Swing, etc.">
                    </div>

                    <!-- Temporalidad y Direcci√≥n -->
                    <div class="form-group">
                        <label class="form-label">Temporalidad</label>
                        <select class="form-select" id="timeframe">
                            <option value="">Seleccionar</option>
                            <option value="M1">M1</option>
                            <option value="M5">M5</option>
                            <option value="M15">M15</option>
                            <option value="M30">M30</option>
                            <option value="H1">H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                            <option value="W1">W1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n</label>
                        <select class="form-select" id="direction">
                            <option value="">Seleccionar</option>
                            <option value="buy">BUY</option>
                            <option value="sell">SELL</option>
                        </select>
                    </div>

                    <!-- Precios -->
                    <div class="form-group">
                        <label class="form-label">Precio Entrada</label>
                        <input type="number" step="0.00001" class="form-input" id="entryPrice" placeholder="1.09500">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio Salida</label>
                        <input type="number" step="0.00001" class="form-input" id="exitPrice" placeholder="1.09600">
                    </div>

                    <!-- SL y TP -->
                    <div class="form-group">
                        <label class="form-label">Stop Loss</label>
                        <input type="number" step="0.00001" class="form-input" id="sl" placeholder="1.09400">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Take Profit</label>
                        <input type="number" step="0.00001" class="form-input" id="tp" placeholder="1.09700">
                    </div>

                    <!-- Tama√±o y Comisi√≥n -->
                    <div class="form-group">
                        <label class="form-label">Tama√±o (Lotes)</label>
                        <input type="number" step="0.01" class="form-input" id="size" placeholder="1.00" value="1.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comisi√≥n ($)</label>
                        <input type="number" step="0.01" class="form-input" id="commission" placeholder="2.50" value="0.00">
                    </div>

                    <!-- PnL Calculados -->
                    <div class="form-group">
                        <label class="form-label">PnL ($)</label>
                        <input type="number" step="0.01" class="form-input" id="pnl" placeholder="Auto-calculado" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PnL (R)</label>
                        <input type="number" step="0.01" class="form-input" id="pnlR" placeholder="Auto-calculado" readonly>
                    </div>

                    <!-- Comentarios -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-textarea" id="comments" rows="3" placeholder="Notas sobre el trade..."></textarea>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="form-actions">
                        <button class="btn btn-primary" id="addTradeBtn">
                            <span>‚ûï</span> Agregar Trade
                        </button>
                        <button class="btn btn-secondary" id="updateTradeBtn" style="display: none;">
                            <span>üíæ</span> Actualizar Trade
                        </button>
                        <button class="btn btn-secondary" id="resetFormBtn">
                            <span>üîÑ</span> Resetear
                        </button>
                        <button class="btn btn-secondary" id="cancelEditBtn" style="display: none;">
                            <span>‚ùå</span> Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabla de Trades -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üìä TRADES REGISTRADOS</div>
                    <div class="table-controls">
                        <input type="text" class="search-box" id="searchInput" placeholder="Buscar trades...">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">Todos</button>
                            <button class="filter-btn" data-filter="win">Ganadores</button>
                            <button class="filter-btn" data-filter="loss">Perdedores</button>
                            <button class="filter-btn" data-filter="buy">BUY</button>
                            <button class="filter-btn" data-filter="sell">SELL</button>
                        </div>
                    </div>
                </div>

                <table class="trades-table" id="tradesTable">
                    <thead>
                        <tr>
                            <th data-sort="entryDate">Fecha Entrada</th>
                            <th data-sort="instrument">Instrumento</th>
                            <th data-sort="direction">Dir</th>
                            <th data-sort="pnl">PnL ($)</th>
                            <th data-sort="pnlR">PnL (R)</th>
                            <th data-sort="strategy">Setup</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- Trades cargados din√°micamente -->
                        <tr id="noTradesRow">
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                                No hay trades registrados. Agrega tu primer trade usando el formulario.
                            </td>
                        </tr>
                    </tbody>
                </table>
                     <div id="paginationControls" style="
    display:flex;
    gap:6px;
    justify-content:center;
    margin-top:10px;
    flex-wrap:wrap;">
</div>


                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div style="font-size: 12px; color: var(--muted);" id="tradeCount">
                        Mostrando 0 trades
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="selectAllBtn" style="font-size: 12px; padding: 4px 8px;">
                            <span>‚úì</span> Seleccionar Todos
                        </button>
                        <button class="btn btn-danger" id="deleteSelectedBtn" style="font-size: 12px; padding: 4px 8px; display: none;">
                            <span>üóë</span> Eliminar Seleccionados (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Inferior -->
        <div class="bottom-panel">
            <!-- Estad√≠sticas R√°pidas -->
            <div class="stats-container">
                <div class="stats-title">
                    <span>üìà ESTAD√çSTICAS R√ÅPIDAS</span>
                    <span id="statsUpdateTime" style="font-size: 11px; color: var(--muted);">Actualizado: --:--</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="statTotalTrades">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="statWinRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Profit Factor</div>
                        <div class="stat-value" id="statProfitFactor">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Expectancy (R)</div>
                        <div class="stat-value" id="statExpectancy">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Mejor Trade (R)</div>
                        <div class="stat-value" id="statBestTrade">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Peor Trade (R)</div>
                        <div class="stat-value negative" id="statWorstTrade">0.00</div>
                    </div>
                </div>
            </div>

            <!-- Importaci√≥n/Exportaci√≥n -->
            <div class="io-container">
                <div class="stats-title">üíæ IMPORTAR / EXPORTAR DATOS</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">
                    Intercambia datos con otros programas del Trading Suite
                </div>
                <div class="io-buttons">
                    <button class="btn btn-primary io-btn" id="exportCsvBtn">
                        <span>üì•</span> Exportar CSV
                    </button>
                    <button class="btn btn-primary io-btn" id="exportJsonBtn">
                        <span>üì•</span> Exportar JSON
                    </button>
                    <label for="importJsonInput" class="btn btn-secondary io-btn" style="cursor: pointer;">
                        <span>üì§</span> Importar JSON
                        <input type="file" id="importJsonInput" class="file-input" accept=".json">
                    </label>
                    <label for="importCsvInput" class="btn btn-secondary io-btn" style="cursor: pointer;">
                        <span>üì§</span> Importar CSV
                        <input type="file" id="importCsvInput" class="file-input" accept=".csv">
                    </label>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                    <div style="font-size: 11px; color: var(--neon-cyan); margin-bottom: 5px;">üîó Compatibilidad:</div>
                    <div style="font-size: 10px; color: var(--muted);">
                        ‚Ä¢ Programa 2 (M√©tricas B√°sicas) ‚Ä¢ Programa 3 (M√©tricas Avanzadas)<br>
                        ‚Ä¢ Programa 4 (Gr√°ficas) ‚Ä¢ Programa 9 (Exportador de Reportes)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA DE RECUPERACI√ìN MEJORADO =====
        const TRADE_STORAGE_KEY = 'trading_suite_trades_v2';
        const BACKUP_KEY = 'trading_suite_backup';
        
        // Configuraci√≥n
        const INSTRUMENTS = ['EURUSD', 'GBPUSD', 'USDJPY', 'XAUUSD', 'BTCUSD', 'ETHUSD', 'SPX', 'NAS100'];
        const STRATEGIES = ['Scalping', 'Day Trading', 'Swing Trading', 'Position Trading', 'Arbitrage', 'Grid'];
        const TIMEFRAMES = ['M1', 'M5', 'M15', 'M30', 'H1', 'H4', 'D1', 'W1', 'MN1'];

       // ===== ESTADO SEGURO =====
let trades = [];
let currentEditId = null;
let currentSort = { column: 'entryDate', direction: 'desc' };
let currentFilter = 'all';
let selectedTrades = new Set();
let isSafeMode = false;

// ===== PAGINACI√ìN =====
let currentPage = 1;
const TRADES_PER_PAGE = 20;


        // ===== VALIDACI√ìN Y SEGURIDAD =====
        function validateTrade(trade) {
            if (!trade || typeof trade !== 'object') {
                return false;
            }
            
            const requiredFields = ['id', 'instrument', 'direction', 'entryPrice', 'exitPrice'];
            
            // Verificar campos requeridos
            for (const field of requiredFields) {
                if (trade[field] === undefined || trade[field] === null || trade[field] === '') {
                    return false;
                }
            }
            
            // Validar tipos num√©ricos b√°sicos
            if (isNaN(parseFloat(trade.entryPrice)) || isNaN(parseFloat(trade.exitPrice))) {
                return false;
            }
            
            // Validar direcci√≥n
            if (!['buy', 'sell'].includes(trade.direction)) {
                return false;
            }
            
            return true;
        }

        function sanitizeTrade(trade) {
            if (!trade || typeof trade !== 'object') {
                return {
                    id: generateId(),
                    entryDate: new Date().toISOString().slice(0, 16),
                    exitDate: new Date().toISOString().slice(0, 16),
                    instrument: '',
                    strategy: '',
                    timeframe: '',
                    direction: 'buy',
                    entryPrice: 0,
                    exitPrice: 0,
                    sl: 0,
                    tp: 0,
                    size: 1,
                    commission: 0,
                    pnl: 0,
                    pnlR: 0,
                    comments: ''
                };
            }
            
            const sanitized = { ...trade };
            
            // Asegurar ID
            if (!sanitized.id || typeof sanitized.id !== 'string') {
                sanitized.id = generateId();
            }
            
            // Convertir tipos num√©ricos
            const numericFields = ['entryPrice', 'exitPrice', 'sl', 'tp', 'size', 'commission', 'pnl', 'pnlR'];
            numericFields.forEach(field => {
                if (sanitized[field] !== undefined && sanitized[field] !== null) {
                    const num = parseFloat(sanitized[field]);
                    sanitized[field] = isNaN(num) ? 0 : num;
                } else {
                    sanitized[field] = 0;
                }
            });
            
            // Asegurar strings
            sanitized.instrument = String(sanitized.instrument || '').toUpperCase().substring(0, 10);
            sanitized.strategy = String(sanitized.strategy || '').substring(0, 50);
            sanitized.timeframe = String(sanitized.timeframe || '');
            sanitized.direction = ['buy', 'sell'].includes(sanitized.direction) ? sanitized.direction : 'buy';
            sanitized.comments = String(sanitized.comments || '').substring(0, 500);
            
            // Asegurar fechas
            try {
                const entryDate = new Date(sanitized.entryDate || new Date());
                const exitDate = new Date(sanitized.exitDate || new Date());
                
                if (isNaN(entryDate.getTime())) {
                    sanitized.entryDate = new Date().toISOString().slice(0, 16);
                } else {
                    sanitized.entryDate = entryDate.toISOString().slice(0, 16);
                }
                
                if (isNaN(exitDate.getTime())) {
                    sanitized.exitDate = new Date().toISOString().slice(0, 16);
                } else {
                    sanitized.exitDate = exitDate.toISOString().slice(0, 16);
                }
            } catch (e) {
                const now = new Date();
                sanitized.entryDate = now.toISOString().slice(0, 16);
                sanitized.exitDate = now.toISOString().slice(0, 16);
            }
            
            return sanitized;
        }

        function backupData() {
            try {
                localStorage.setItem(BACKUP_KEY, JSON.stringify({
                    timestamp: new Date().toISOString(),
                    trades: trades,
                    count: trades.length
                }));
                return true;
            } catch (e) {
                console.error('Error haciendo backup:', e);
                return false;
            }
        }

        function restoreBackup() {
            try {
                const backup = localStorage.getItem(BACKUP_KEY);
                if (backup) {
                    const data = JSON.parse(backup);
                    if (data.trades && Array.isArray(data.trades)) {
                        return data.trades;
                    }
                }
            } catch (e) {
                console.error('Error restaurando backup:', e);
            }
            return [];
        }

        function checkDataHealth() {
            try {
                const stored = localStorage.getItem(TRADE_STORAGE_KEY);
                if (!stored) return { healthy: true, reason: 'No data' };
                
                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed)) {
                    return { 
                        healthy: false, 
                        reason: 'Data is not an array',
                        data: parsed 
                    };
                }
                
                // Verificar cada trade
                for (let i = 0; i < parsed.length; i++) {
                    if (!validateTrade(parsed[i])) {
                        return {
                            healthy: false,
                            reason: `Invalid trade at index ${i}`,
                            data: parsed[i]
                        };
                    }
                }
                
                return { healthy: true, reason: 'All trades valid' };
                
            } catch (e) {
                return {
                    healthy: false,
                    reason: `Parse error: ${e.message}`,
                    error: e
                };
            }
        }

        function repairData() {
            try {
                const stored = localStorage.getItem(TRADE_STORAGE_KEY);
                if (!stored) {
                    trades = [];
                    return { repaired: 0, total: 0 };
                }
                
                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed)) {
                    // Si no es array, intentar extraer trades
                    let extracted = [];
                    if (parsed.trades && Array.isArray(parsed.trades)) {
                        extracted = parsed.trades;
                    } else if (typeof parsed === 'object') {
                        // Intentar convertir objeto a array
                        extracted = Object.values(parsed).filter(item => 
                            item && typeof item === 'object' && 'instrument' in item
                        );
                    }
                    
                    trades = extracted.map(trade => sanitizeTrade(trade)).filter(validateTrade);
                } else {
                    // Es array, sanitizar y validar
                    trades = parsed.map(trade => sanitizeTrade(trade)).filter(validateTrade);
                }
                
                saveTrades();
                return { repaired: trades.length, total: parsed.length };
                
            } catch (e) {
                console.error('Error repairing data:', e);
                trades = restoreBackup() || [];
                saveTrades();
                return { repaired: trades.length, total: 0, error: e.message };
            }
        }

        function showRecoveryModal(reason) {
            const modal = document.getElementById('recoveryModal');
            const content = modal.querySelector('.recovery-content');
            
            content.querySelector('.recovery-title').innerHTML = 
                `<span>‚ö†Ô∏è</span> DATOS CORRUPTOS DETECTADOS`;
            
            content.querySelector('p').innerHTML = `
                <strong>Raz√≥n:</strong> ${reason}<br><br>
                Esto puede causar que la aplicaci√≥n se congele o funcione incorrectamente.
                ¬øQu√© acci√≥n deseas tomar?
            `;
            
            modal.classList.remove('hidden');
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function formatDateTimeLocal(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function generateId() {
            return 'trade_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function calculatePnl(entry, exit, size, direction, commission = 0) {
            try {
                if (!entry || !exit || !size || !direction) return 0;
                
                const pips = (exit - entry) * (direction === 'buy' ? 1 : -1);
                // Para Forex: 1 lote est√°ndar = 100,000 unidades
                // PnL = (Pips * Tama√±o en lotes * Valor del pip) - Comisi√≥n
                // Valor del pip para EURUSD ‚âà $10 por lote est√°ndar
                const pnl = (pips * size * 10000) - (commission || 0);
                return parseFloat(pnl.toFixed(2));
            } catch (e) {
                console.error('Error calculando PnL:', e);
                return 0;
            }
        }

        function calculatePnlR(entry, exit, sl, direction) {
            try {
                if (!entry || !exit || !sl || sl === 0 || entry === sl) return 0;
                
                const risk = Math.abs(entry - sl);
                if (risk === 0) return 0;
                
                const reward = Math.abs(exit - entry);
                let rMultiple;
                
                if (direction === 'buy') {
                    rMultiple = (exit > entry ? 1 : -1) * (reward / risk);
                } else {
                    rMultiple = (exit < entry ? 1 : -1) * (reward / risk);
                }
                
                return parseFloat(rMultiple.toFixed(2));
            } catch (e) {
                console.error('Error calculando PnL(R):', e);
                return 0;
            }
        }

        // ===== MANEJO DE DATOS SEGURO =====
        function saveTrades() {
            try {
                if (isSafeMode) {
                    showNotification('Modo seguro: Los datos no se guardar√°n.', 'warning');
                    return false;
                }
                
                // Crear backup antes de guardar
                backupData();
                
                // Guardar solo trades v√°lidos
                const validTrades = trades.filter(validateTrade);
                localStorage.setItem(TRADE_STORAGE_KEY, JSON.stringify(validTrades));
                
                // Actualizar estad√≠sticas
                updateStatistics();
                
                return true;
            } catch (e) {
                console.error('Error saving trades:', e);
                showNotification('Error guardando datos. Verifica el almacenamiento.', 'error');
                return false;
            }
        }

        function loadInitialData() {
            try {
                const stored = localStorage.getItem(TRADE_STORAGE_KEY);
                
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        trades = parsed.map(trade => sanitizeTrade(trade)).filter(validateTrade);
                        console.log(`Cargados ${trades.length} trades desde localStorage`);
                    }
                }
                
                // Configurar fechas por defecto
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                
                document.getElementById('entryDate').value = formatDateTimeLocal(oneHourAgo);
                document.getElementById('exitDate').value = formatDateTimeLocal(now);
                
                // Cargar y renderizar
                safeLoadTrades();
                
            } catch (e) {
                console.error('Error loading initial data:', e);
                trades = [];
                showNotification('Error cargando datos, iniciando en modo seguro', 'error');
            }
        }

        function safeLoadTrades() {
            try {
               const filteredTrades = filterTrades(trades);
const sortedTrades = sortTrades(filteredTrades);

const { paginatedTrades, totalPages } = paginateTrades(sortedTrades);

renderTradesTable(paginatedTrades);
renderPaginationControls(totalPages);

            }
        }

        function filterTrades(tradesList) {
            if (!Array.isArray(tradesList)) return [];
            
            switch(currentFilter) {
                case 'win': return tradesList.filter(t => t.pnl > 0);
                case 'loss': return tradesList.filter(t => t.pnl < 0);
                case 'buy': return tradesList.filter(t => t.direction === 'buy');
                case 'sell': return tradesList.filter(t => t.direction === 'sell');
                default: return tradesList;
            }
        }

        function sortTrades(tradesList) {
            if (!Array.isArray(tradesList)) return [];
            
            return [...tradesList].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];
                
                if (currentSort.column.includes('Date')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

          function paginateTrades(tradesList) {
    const totalPages = Math.ceil(tradesList.length / TRADES_PER_PAGE);
    const start = (currentPage - 1) * TRADES_PER_PAGE;
    const end = start + TRADES_PER_PAGE;

    return {
        paginatedTrades: tradesList.slice(start, end),
        totalPages
    };
}


        // ===== RENDERIZADO DE TABLA CORREGIDO =====
        function renderTradesTable(tradesList) {
            const tbody = document.getElementById('tradesTableBody');
            const tradeCountElement = document.getElementById('tradeCount');
            
            if (!tbody) {
                console.error('Elemento tbody no encontrado');
                return;
            }
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            if (!tradesList || tradesList.length === 0) {
                // Crear fila de "no hay trades"
                const noTradesRow = document.createElement('tr');
                noTradesRow.id = 'noTradesRow';
                noTradesRow.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                        No hay trades registrados. Agrega tu primer trade usando el formulario.
                    </td>
                `;
                tbody.appendChild(noTradesRow);
                tradeCountElement.textContent = 'Mostrando 0 trades';
                selectedTrades.clear();
                updateSelectionUI();
                return;
            }
            
            // Renderizar cada trade
            tradesList.forEach(trade => {
                try {
                    const row = document.createElement('tr');
                    const isSelected = selectedTrades.has(trade.id);
                    
                    if (isSelected) {
                        row.style.background = 'rgba(0, 240, 255, 0.1)';
                    }
                    
                    row.innerHTML = `
                        <td>${formatDate(trade.entryDate)}</td>
                        <td><strong>${trade.instrument || ''}</strong></td>
                        <td class="direction-${trade.direction}">${(trade.direction || '').toUpperCase()}</td>
                        <td class="${(trade.pnl || 0) >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                            ${(trade.pnl || 0) >= 0 ? '+' : ''}${(trade.pnl || 0).toFixed(2)}
                        </td>
                        <td class="${(trade.pnlR || 0) >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                            ${(trade.pnlR || 0) >= 0 ? '+' : ''}${(trade.pnlR || 0).toFixed(2)}R
                        </td>
                        <td>${trade.strategy || ''}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" data-id="${trade.id}" title="Editar">
                                    ‚úé
                                </button>
                                <button class="action-btn delete-btn" data-id="${trade.id}" title="Eliminar">
                                    üóë
                                </button>
                                <button class="action-btn duplicate-btn" data-id="${trade.id}" title="Duplicar">
                                    ‚éò
                                </button>
                                <input type="checkbox" class="trade-checkbox" data-id="${trade.id}" 
                                       ${isSelected ? 'checked' : ''}
                                       style="margin-left: 5px;">
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                } catch (e) {
                    console.error('Error rendering trade row:', trade, e);
                }
            });
            
            tradeCountElement.textContent = `Mostrando ${tradesList.length} de ${trades.length} trades`;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Fecha inv√°lida';
            }
        }

        // ===== FUNCI√ìN PARA RESALTAR FILAS SELECCIONADAS =====
        function highlightSelectedRows() {
            const rows = document.querySelectorAll('#tradesTableBody tr');
            rows.forEach(row => {
                const checkbox = row.querySelector('.trade-checkbox');
                if (checkbox) {
                    const tradeId = checkbox.dataset.id;
                    if (selectedTrades.has(tradeId)) {
                        row.style.background = 'rgba(0, 240, 255, 0.1)';
                    } else {
                        row.style.background = '';
                    }
                }
            });
        }

        // ===== MANEJO DEL FORMULARIO =====
        function setupAutoCalculations() {
            const inputs = ['entryPrice', 'exitPrice', 'sl', 'size', 'commission', 'direction'];
            
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateTradeValues);
                }
            });
        }

        function calculateTradeValues() {
            try {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
                const exitPrice = parseFloat(document.getElementById('exitPrice').value) || 0;
                const sl = parseFloat(document.getElementById('sl').value) || 0;
                const size = parseFloat(document.getElementById('size').value) || 0;
                const commission = parseFloat(document.getElementById('commission').value) || 0;
                const direction = document.getElementById('direction').value;
                
                if (entryPrice && exitPrice && direction) {
                    const pnl = calculatePnl(entryPrice, exitPrice, size, direction, commission);
                    const pnlR = calculatePnlR(entryPrice, exitPrice, sl, direction);
                    
                    document.getElementById('pnl').value = pnl.toFixed(2);
                    document.getElementById('pnlR').value = pnlR.toFixed(2);
                }
            } catch (e) {
                console.error('Error calculating trade values:', e);
            }
        }

        function resetForm() {
            try {
                currentEditId = null;
                
                document.getElementById('addTradeBtn').style.display = 'flex';
                document.getElementById('updateTradeBtn').style.display = 'none';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('formModeIndicator').textContent = 'Modo: Creaci√≥n';
                
                // Restaurar fechas por defecto
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                document.getElementById('entryDate').value = formatDateTimeLocal(oneHourAgo);
                document.getElementById('exitDate').value = formatDateTimeLocal(now);
                
                // Limpiar otros campos
                ['instrument', 'strategy', 'entryPrice', 'exitPrice', 'sl', 'tp', 
                 'size', 'commission', 'comments'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                
                // Resetear selects
                ['timeframe', 'direction'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.selectedIndex = 0;
                });
                
                // Limpiar PnL calculados
                document.getElementById('pnl').value = '';
                document.getElementById('pnlR').value = '';
                
            } catch (e) {
                console.error('Error resetting form:', e);
            }
        }

        function validateForm() {
            const required = [
                {id: 'instrument', name: 'Instrumento'},
                {id: 'direction', name: 'Direcci√≥n'},
                {id: 'entryPrice', name: 'Precio Entrada'},
                {id: 'exitPrice', name: 'Precio Salida'}
            ];
            
            let isValid = true;
            let errorMessages = [];
            
            required.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && !element.value.trim()) {
                    element.style.borderColor = 'var(--neon-red)';
                    errorMessages.push(field.name);
                    isValid = false;
                } else if (element) {
                    element.style.borderColor = '';
                }
            });
            
            // Validar que exitDate sea despu√©s de entryDate
            const entryDate = new Date(document.getElementById('entryDate').value);
            const exitDate = new Date(document.getElementById('exitDate').value);
            if (exitDate <= entryDate) {
                document.getElementById('exitDate').style.borderColor = 'var(--neon-red)';
                errorMessages.push('La fecha de salida debe ser posterior a la fecha de entrada');
                isValid = false;
            } else {
                document.getElementById('exitDate').style.borderColor = '';
            }
            
            if (!isValid && errorMessages.length > 0) {
                showNotification(`Campos requeridos: ${errorMessages.join(', ')}`, 'error');
            }
            
            return isValid;
        }

        // ===== FUNCI√ìN addTrade CORREGIDA =====
        function addTrade() {
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden agregar trades', 'warning');
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            try {
                // Obtener valores del formulario
                const entryDate = document.getElementById('entryDate').value;
                const exitDate = document.getElementById('exitDate').value;
                const instrument = document.getElementById('instrument').value;
                const strategy = document.getElementById('strategy').value;
                const timeframe = document.getElementById('timeframe').value;
                const direction = document.getElementById('direction').value;
                const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
                const exitPrice = parseFloat(document.getElementById('exitPrice').value) || 0;
                const sl = parseFloat(document.getElementById('sl').value) || 0;
                const tp = parseFloat(document.getElementById('tp').value) || 0;
                const size = parseFloat(document.getElementById('size').value) || 1;
                const commission = parseFloat(document.getElementById('commission').value) || 0;
                const comments = document.getElementById('comments').value;
                
                // Validar datos cr√≠ticos
                if (!instrument || !direction) {
                    showNotification('Instrumento y Direcci√≥n son campos requeridos', 'error');
                    return;
                }
                
                if (!entryPrice || !exitPrice) {
                    showNotification('Precios de Entrada y Salida son requeridos', 'error');
                    return;
                }
                
                // Calcular PnL y PnL(R)
                const pnl = calculatePnl(entryPrice, exitPrice, size, direction, commission);
                const pnlR = calculatePnlR(entryPrice, exitPrice, sl, direction);
                
                // Crear objeto trade
                const trade = {
                    id: generateId(),
                    entryDate: entryDate,
                    exitDate: exitDate,
                    instrument: instrument.toUpperCase(),
                    strategy: strategy || '',
                    timeframe: timeframe || '',
                    direction: direction,
                    entryPrice: entryPrice,
                    exitPrice: exitPrice,
                    sl: sl,
                    tp: tp,
                    size: size,
                    commission: commission,
                    pnl: pnl,
                    pnlR: pnlR,
                    comments: comments || ''
                };
                
                // Validar trade antes de agregar
                if (!validateTrade(trade)) {
                    showNotification('Datos del trade inv√°lidos. Verifica los campos.', 'error');
                    return;
                }
                
                // Agregar trade al array
                trades.push(trade);
                
                // Guardar y recargar
                if (saveTrades()) {
                    safeLoadTrades();
                    resetForm();
                    showNotification('Trade agregado exitosamente', 'success');
                } else {
                    // Si hay error al guardar, revertir
                    trades.pop();
                    showNotification('Error guardando el trade. Intenta nuevamente.', 'error');
                }
                
            } catch (e) {
                console.error('Error adding trade:', e);
                showNotification('Error agregando trade. Verifica que todos los campos sean v√°lidos.', 'error');
            }
        }

        function editTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) {
                showNotification('Trade no encontrado', 'error');
                return;
            }
            
            currentEditId = tradeId;
            
            try {
                // Llenar formulario
                document.getElementById('entryDate').value = trade.entryDate;
                document.getElementById('exitDate').value = trade.exitDate;
                document.getElementById('instrument').value = trade.instrument;
                document.getElementById('strategy').value = trade.strategy || '';
                document.getElementById('timeframe').value = trade.timeframe || '';
                document.getElementById('direction').value = trade.direction;
                document.getElementById('entryPrice').value = trade.entryPrice;
                document.getElementById('exitPrice').value = trade.exitPrice;
                document.getElementById('sl').value = trade.sl || '';
                document.getElementById('tp').value = trade.tp || '';
                document.getElementById('size').value = trade.size || 1;
                document.getElementById('commission').value = trade.commission || 0;
                document.getElementById('pnl').value = trade.pnl || 0;
                document.getElementById('pnlR').value = trade.pnlR || 0;
                document.getElementById('comments').value = trade.comments || '';
                
                // Cambiar modo del formulario
                document.getElementById('addTradeBtn').style.display = 'none';
                document.getElementById('updateTradeBtn').style.display = 'flex';
                document.getElementById('cancelEditBtn').style.display = 'flex';
                document.getElementById('formModeIndicator').textContent = 'Modo: Edici√≥n';
                
                showNotification('Editando trade...', 'info');
                
            } catch (e) {
                console.error('Error editing trade:', e);
                showNotification('Error cargando trade para edici√≥n', 'error');
            }
        }

        function updateTrade() {
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden actualizar trades', 'warning');
                return;
            }
            
            if (!currentEditId || !validateForm()) return;
            
            try {
                const index = trades.findIndex(t => t.id === currentEditId);
                if (index === -1) {
                    showNotification('Trade no encontrado', 'error');
                    return;
                }
                
                const updatedTrade = sanitizeTrade({
                    ...trades[index],
                    entryDate: document.getElementById('entryDate').value,
                    exitDate: document.getElementById('exitDate').value,
                    instrument: document.getElementById('instrument').value,
                    strategy: document.getElementById('strategy').value,
                    timeframe: document.getElementById('timeframe').value,
                    direction: document.getElementById('direction').value,
                    entryPrice: document.getElementById('entryPrice').value,
                    exitPrice: document.getElementById('exitPrice').value,
                    sl: document.getElementById('sl').value,
                    tp: document.getElementById('tp').value,
                    size: document.getElementById('size').value,
                    commission: document.getElementById('commission').value,
                    comments: document.getElementById('comments').value
                });
                
                // Recalcular PnL
                updatedTrade.pnl = calculatePnl(
                    updatedTrade.entryPrice, 
                    updatedTrade.exitPrice, 
                    updatedTrade.size, 
                    updatedTrade.direction, 
                    updatedTrade.commission
                );
                
                updatedTrade.pnlR = calculatePnlR(
                    updatedTrade.entryPrice, 
                    updatedTrade.exitPrice, 
                    updatedTrade.sl, 
                    updatedTrade.direction
                );
                
                trades[index] = updatedTrade;
                saveTrades();
                safeLoadTrades();
                resetForm();
                
                showNotification('Trade actualizado exitosamente', 'success');
                
            } catch (e) {
                console.error('Error updating trade:', e);
                showNotification('Error actualizando trade', 'error');
            }
        }

        function deleteTrade(tradeId) {
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden eliminar trades', 'warning');
                return;
            }
            
            if (!confirm('¬øEst√° seguro de eliminar este trade?')) return;
            
            try {
                const initialCount = trades.length;
                trades = trades.filter(t => t.id !== tradeId);
                selectedTrades.delete(tradeId);
                
                if (saveTrades()) {
                    safeLoadTrades();
                    showNotification(`Trade eliminado (${initialCount - trades.length})`, 'warning');
                }
                
            } catch (e) {
                console.error('Error deleting trade:', e);
                showNotification('Error eliminando trade', 'error');
            }
        }

        function duplicateTrade(tradeId) {
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden duplicar trades', 'warning');
                return;
            }
            
            const original = trades.find(t => t.id === tradeId);
            if (!original) {
                showNotification('Trade no encontrado', 'error');
                return;
            }
            
            try {
                const duplicate = sanitizeTrade({
                    ...original,
                    id: generateId(),
                    entryDate: new Date().toISOString().slice(0, 16),
                    exitDate: new Date(Date.now() + 60 * 60 * 1000).toISOString().slice(0, 16),
                    comments: `(Duplicado) ${original.comments || ''}`
                });
                
                trades.push(duplicate);
                saveTrades();
                safeLoadTrades();
                
                showNotification('Trade duplicado', 'info');
                
            } catch (e) {
                console.error('Error duplicating trade:', e);
                showNotification('Error duplicando trade', 'error');
            }
        }

        // ===== ESTAD√çSTICAS MEJORADAS =====
        function updateStatistics() {
            try {
                if (!trades || trades.length === 0) {
                    resetStatistics();
                    return;
                }
                
                // C√°lculos b√°sicos
                const totalTrades = trades.length;
                const winningTrades = trades.filter(t => (t.pnl || 0) > 0).length;
                const losingTrades = totalTrades - winningTrades;
                const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
                
                // Profit Factor
                const totalWins = trades
                    .filter(t => (t.pnl || 0) > 0)
                    .reduce((sum, t) => sum + (t.pnl || 0), 0);
                
                const totalLosses = Math.abs(
                    trades
                        .filter(t => (t.pnl || 0) < 0)
                        .reduce((sum, t) => sum + (t.pnl || 0), 0)
                );
                
                let profitFactor;
                if (totalLosses > 0) {
                    profitFactor = totalWins / totalLosses;
                } else if (totalWins > 0) {
                    profitFactor = Infinity;
                } else {
                    profitFactor = 0;
                }
                
                // Expectancy (R)
                const validRTrades = trades.filter(t => 
                    t.pnlR !== undefined && 
                    t.pnlR !== null && 
                    !isNaN(t.pnlR)
                );
                
                const expectancy = validRTrades.length > 0 ? 
                    validRTrades.reduce((sum, t) => sum + (t.pnlR || 0), 0) / validRTrades.length : 0;
                
                // Mejor y peor trade (R)
                const validPnLR = trades
                    .map(t => t.pnlR)
                    .filter(val => val !== undefined && val !== null && !isNaN(val));
                
                let bestTrade = 0;
                let worstTrade = 0;
                
                if (validPnLR.length > 0) {
                    bestTrade = Math.max(...validPnLR);
                    worstTrade = Math.min(...validPnLR);
                }
                
                // Actualizar UI
                const statTotalTrades = document.getElementById('statTotalTrades');
                const statWinRate = document.getElementById('statWinRate');
                const statProfitFactor = document.getElementById('statProfitFactor');
                const statExpectancy = document.getElementById('statExpectancy');
                const statBestTrade = document.getElementById('statBestTrade');
                const statWorstTrade = document.getElementById('statWorstTrade');
                
                if (statTotalTrades) statTotalTrades.textContent = totalTrades;
                if (statWinRate) statWinRate.textContent = `${winRate.toFixed(1)}%`;
                if (statProfitFactor) {
                    statProfitFactor.textContent = profitFactor === Infinity ? '‚àû' : profitFactor.toFixed(2);
                }
                if (statExpectancy) statExpectancy.textContent = expectancy.toFixed(2);
                if (statBestTrade) statBestTrade.textContent = bestTrade.toFixed(2);
                if (statWorstTrade) {
                    statWorstTrade.textContent = worstTrade.toFixed(2);
                    statWorstTrade.className = worstTrade < 0 ? 'stat-value negative' : 'stat-value';
                }
                
                // Actualizar tiempo
                const now = new Date();
                const statsUpdateTime = document.getElementById('statsUpdateTime');
                if (statsUpdateTime) {
                    statsUpdateTime.textContent = 
                        `Actualizado: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                }
                
            } catch (e) {
                console.error('Error updating statistics:', e);
                resetStatistics();
            }
        }

        function resetStatistics() {
            const stats = ['statTotalTrades', 'statWinRate', 'statProfitFactor', 'statExpectancy', 'statBestTrade', 'statWorstTrade'];
            stats.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'statTotalTrades') element.textContent = '0';
                    else if (id === 'statWinRate') element.textContent = '0%';
                    else element.textContent = '0.00';
                }
            });
        }

        // ===== DEBUG =====
        function debugData() {
            console.log('=== DEBUG DE DATOS ===');
            console.log('Trades en memoria:', trades.length);
            console.log('Trades en localStorage:', localStorage.getItem(TRADE_STORAGE_KEY) ? JSON.parse(localStorage.getItem(TRADE_STORAGE_KEY)).length : 0);
            console.log('Modo seguro:', isSafeMode);
            console.log('Trades array:', trades);
            
            if (trades.length > 0) {
                console.log('Primer trade:', trades[0]);
                console.log('√öltimo trade:', trades[trades.length - 1]);
            }
            
            // Mostrar alerta con informaci√≥n
            alert(`DEBUG INFO:\n\n` +
                  `Trades en memoria: ${trades.length}\n` +
                  `Trades guardados: ${localStorage.getItem(TRADE_STORAGE_KEY) ? JSON.parse(localStorage.getItem(TRADE_STORAGE_KEY)).length : 0}\n` +
                  `Modo seguro: ${isSafeMode ? 'SI' : 'NO'}\n` +
                  `Filtro actual: ${currentFilter}`);
        }

        // ===== IMPORTACI√ìN/EXPORTACI√ìN =====
        function exportToCSV() {
            if (trades.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                const headers = ['Fecha Entrada', 'Fecha Salida', 'Instrumento', 'Setup', 'Temporalidad', 
                               'Direcci√≥n', 'Precio Entrada', 'Precio Salida', 'SL', 'TP', 'Tama√±o', 
                               'Comisi√≥n', 'PnL', 'PnL (R)', 'Comentarios'];
                
                const csvRows = [
                    headers.join(','),
                    ...trades.map(trade => [
                        trade.entryDate,
                        trade.exitDate,
                        `"${trade.instrument || ''}"`,
                        `"${trade.strategy || ''}"`,
                        trade.timeframe || '',
                        trade.direction,
                        trade.entryPrice || 0,
                        trade.exitPrice || 0,
                        trade.sl || 0,
                        trade.tp || 0,
                        trade.size || 0,
                        trade.commission || 0,
                        trade.pnl || 0,
                        trade.pnlR || 0,
                        `"${(trade.comments || '').replace(/"/g, '""')}"`
                    ].join(','))
                ];
                
                const csvContent = csvRows.join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.href = url;
                link.setAttribute('download', `trades_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification('CSV exportado exitosamente', 'success');
                
            } catch (e) {
                console.error('Error exporting CSV:', e);
                showNotification('Error exportando CSV', 'error');
            }
        }

        function exportToJSON() {
            if (trades.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                const exportData = {
                    version: '2.0',
                    meta: {
                        exportDate: new Date().toISOString(),
                        sourceProgram: 'programa-1',
                        tradesCount: trades.length,
                        totalPnL: trades.reduce((sum, t) => sum + (t.pnl || 0), 0),
                        dataFormat: 'trading_suite_standard'
                    },
                    trades: trades
                };
                
                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.href = url;
                link.setAttribute('download', `trades_${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification('JSON exportado exitosamente', 'success');
                
            } catch (e) {
                console.error('Error exporting JSON:', e);
                showNotification('Error exportando JSON', 'error');
            }
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden importar datos', 'warning');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let importedTrades = [];
                    
                    // Validar estructura del archivo
                    if (!importedData) {
                        throw new Error('Archivo vac√≠o o inv√°lido');
                    }
                    
                    // Extraer trades seg√∫n diferentes formatos
                    if (Array.isArray(importedData)) {
                        importedTrades = importedData;
                    } else if (importedData.trades && Array.isArray(importedData.trades)) {
                        importedTrades = importedData.trades;
                    } else if (typeof importedData === 'object') {
                        Object.values(importedData).forEach(value => {
                            if (Array.isArray(value) && value.length > 0 && value[0].instrument) {
                                importedTrades = value;
                            }
                        });
                    }
                    
                    if (importedTrades.length === 0) {
                        throw new Error('No se encontraron trades v√°lidos en el archivo');
                    }
                    
                    // Validar y sanitizar cada trade
                    const validTrades = importedTrades
                        .map(trade => sanitizeTrade(trade))
                        .filter(validateTrade);
                    
                    if (validTrades.length === 0) {
                        throw new Error('No se encontraron trades v√°lidos despu√©s de la validaci√≥n');
                    }
                    
                    const importMethod = confirm(
                        `Se encontraron ${validTrades.length} trades v√°lidos.\n\n` +
                        `¬øDesea agregarlos al final?`
                    );
                    
                    if (!importMethod) {
                        showNotification('Importaci√≥n cancelada', 'info');
                        return;
                    }
                    
                    validTrades.forEach(trade => {
                        trade.id = generateId();
                        trades.push(trade);
                    });
                    
                    saveTrades();
                    safeLoadTrades();
                    
                    showNotification(`${validTrades.length} trades importados exitosamente`, 'success');
                    
                } catch (error) {
                    console.error('Error importing JSON:', error);
                    showNotification(`Error importando: ${error.message}`, 'error');
                }
                
                event.target.value = '';
            };
            
            reader.onerror = function() {
                showNotification('Error leyendo el archivo', 'error');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden importar datos', 'warning');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const rows = csvContent.split('\n').filter(row => row.trim());
                    
                    if (rows.length < 2) {
                        throw new Error('Archivo CSV vac√≠o o sin datos');
                    }
                    
                    const headers = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    
                    const importedTrades = [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row.trim()) continue;
                        
                        // Manejo de CSV con comas dentro de comillas
                        const values = [];
                        let inQuotes = false;
                        let currentValue = '';
                        
                        for (let char of row) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim());
                        
                        const trade = {};
                        
                        headers.forEach((header, index) => {
                            let value = values[index] || '';
                            value = value.replace(/^"|"$/g, '');
                            
                            switch(header) {
                                case 'Fecha Entrada': trade.entryDate = value; break;
                                case 'Fecha Salida': trade.exitDate = value; break;
                                case 'Instrumento': trade.instrument = value; break;
                                case 'Setup': trade.strategy = value; break;
                                case 'Temporalidad': trade.timeframe = value; break;
                                case 'Direcci√≥n': trade.direction = value.toLowerCase(); break;
                                case 'Precio Entrada': trade.entryPrice = parseFloat(value) || 0; break;
                                case 'Precio Salida': trade.exitPrice = parseFloat(value) || 0; break;
                                case 'SL': trade.sl = parseFloat(value) || 0; break;
                                case 'TP': trade.tp = parseFloat(value) || 0; break;
                                case 'Tama√±o': trade.size = parseFloat(value) || 1; break;
                                case 'Comisi√≥n': trade.commission = parseFloat(value) || 0; break;
                                case 'PnL': trade.pnl = parseFloat(value) || 0; break;
                                case 'PnL (R)': trade.pnlR = parseFloat(value) || 0; break;
                                case 'Comentarios': trade.comments = value; break;
                            }
                        });
                        
                        trade.id = generateId();
                        importedTrades.push(trade);
                    }
                    
                    // Validar y sanitizar
                    const validTrades = importedTrades
                        .map(trade => sanitizeTrade(trade))
                        .filter(validateTrade);
                    
                    if (validTrades.length === 0) {
                        throw new Error('No se encontraron trades v√°lidos en el CSV');
                    }
                    
                    const importMethod = confirm(
                        `Se encontraron ${validTrades.length} trades v√°lidos.\n\n` +
                        `¬øDesea agregarlos al final?`
                    );
                    
                    if (!importMethod) {
                        showNotification('Importaci√≥n cancelada', 'info');
                        return;
                    }
                    
                    validTrades.forEach(trade => trades.push(trade));
                    saveTrades();
                    safeLoadTrades();
                    
                    showNotification(`${validTrades.length} trades importados desde CSV`, 'success');
                    
                } catch (error) {
                    console.error('Error importing CSV:', error);
                    showNotification(`Error importando CSV: ${error.message}`, 'error');
                }
                
                event.target.value = '';
            };
            
            reader.onerror = function() {
                showNotification('Error leyendo el archivo CSV', 'error');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Formulario
            document.getElementById('addTradeBtn').addEventListener('click', addTrade);
            document.getElementById('updateTradeBtn').addEventListener('click', updateTrade);
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
            
            // Tabla y b√∫squeda
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filtered = trades.filter(t => 
                    (t.instrument && t.instrument.toLowerCase().includes(searchTerm)) ||
                    (t.strategy && t.strategy.toLowerCase().includes(searchTerm)) ||
                    (t.comments && t.comments.toLowerCase().includes(searchTerm))
                );
                renderTradesTable(sortTrades(filtered));
            });
            
            // Filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    safeLoadTrades();
                });
            });
            
            // Ordenamiento
            document.querySelectorAll('#tradesTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    
                    // Actualizar indicadores visuales
                    document.querySelectorAll('#tradesTable th').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    this.classList.add(`sort-${currentSort.direction}`);
                    
                    safeLoadTrades();
                });
            });
            
            // Importaci√≥n/Exportaci√≥n
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJSON);
            document.getElementById('importJsonInput').addEventListener('change', importFromJSON);
            document.getElementById('importCsvInput').addEventListener('change', importFromCSV);
            
            // Selecci√≥n m√∫ltiple
            document.getElementById('selectAllBtn').addEventListener('click', function() {
                try {
                    const checkboxes = document.querySelectorAll('.trade-checkbox');
                    
                    if (checkboxes.length === 0) return;
                    
                    const allSelected = Array.from(checkboxes).every(cb => cb.checked);
                    
                    checkboxes.forEach(cb => {
                        cb.checked = !allSelected;
                        const tradeId = cb.dataset.id;
                        if (tradeId) {
                            if (!allSelected) {
                                selectedTrades.add(tradeId);
                            } else {
                                selectedTrades.delete(tradeId);
                            }
                        }
                    });
                    
                    highlightSelectedRows();
                    updateSelectionUI();
                    
                } catch (error) {
                    console.error('Error en selecci√≥n m√∫ltiple:', error);
                    showNotification('Error en selecci√≥n. Intenta nuevamente.', 'error');
                }
            });
            
            // Eliminaci√≥n de seleccionados
            document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
                if (selectedTrades.size === 0 || isSafeMode) {
                    if (isSafeMode) {
                        showNotification('Modo seguro activado', 'warning');
                    }
                    return;
                }
                
                if (!confirm(`¬øEliminar ${selectedTrades.size} trades seleccionados?`)) return;
                
                try {
                    const newTrades = trades.filter(t => !selectedTrades.has(t.id));
                    const deletedCount = trades.length - newTrades.length;
                    
                    trades = newTrades;
                    selectedTrades.clear();
                    
                    if (saveTrades()) {
                        safeLoadTrades();
                        showNotification(`${deletedCount} trades eliminados`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Error eliminando trades seleccionados:', error);
                    showNotification('Error eliminando trades. Los datos se mantienen intactos.', 'error');
                    safeLoadTrades();
                }
            });
            
            // Manejo de checkboxes individuales
            document.getElementById('tradesTableBody').addEventListener('change', function(e) {
                if (e.target.classList.contains('trade-checkbox')) {
                    const tradeId = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedTrades.add(tradeId);
                    } else {
                        selectedTrades.delete(tradeId);
                    }
                    highlightSelectedRows();
                    updateSelectionUI();
                }
            });
            
            // Delegaci√≥n de eventos para acciones de tabla
            document.getElementById('tradesTableBody').addEventListener('click', function(e) {
                const target = e.target;
                const tradeId = target.closest('button')?.dataset.id;
                
                if (!tradeId) return;
                
                if (target.classList.contains('edit-btn')) {
                    editTrade(tradeId);
                } else if (target.classList.contains('delete-btn')) {
                    deleteTrade(tradeId);
                } else if (target.classList.contains('duplicate-btn')) {
                    duplicateTrade(tradeId);
                }
            });
        }

        function updateSelectionUI() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const selectedCountElement = document.getElementById('selectedCount');
            
            if (!deleteBtn || !selectAllBtn || !selectedCountElement) return;
            
            if (selectedTrades.size > 0) {
                deleteBtn.style.display = 'flex';
                selectAllBtn.innerHTML = '<span>‚úó</span> Deseleccionar Todos';
                selectedCountElement.textContent = selectedTrades.size;
            } else {
                deleteBtn.style.display = 'none';
                selectAllBtn.innerHTML = '<span>‚úì</span> Seleccionar Todos';
                selectedCountElement.textContent = '0';
            }
        }

        // ===== DATOS DE EJEMPLO =====
        function loadSampleData() {
            if (isSafeMode) {
                showNotification('Modo seguro: No se pueden cargar datos de ejemplo', 'warning');
                return;
            }
            
            const sampleTrades = [
                {
                    id: generateId(),
                    entryDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    exitDate: new Date(Date.now() - 6.5 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    instrument: 'EURUSD',
                    strategy: 'Scalping',
                    timeframe: 'M5',
                    direction: 'buy',
                    entryPrice: 1.0950,
                    exitPrice: 1.0965,
                    sl: 1.0940,
                    tp: 1.0975,
                    size: 1.0,
                    commission: 2.5,
                    pnl: 150.0,
                    pnlR: 1.5,
                    comments: 'Trade seg√∫n setup MA crossover en M5'
                },
                {
                    id: generateId(),
                    entryDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    exitDate: new Date(Date.now() - 2.5 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    instrument: 'XAUUSD',
                    strategy: 'Swing Trading',
                    timeframe: 'H4',
                    direction: 'sell',
                    entryPrice: 2050.00,
                    exitPrice: 2035.00,
                    sl: 2065.00,
                    tp: 2020.00,
                    size: 0.5,
                    commission: 5.0,
                    pnl: 750.0,
                    pnlR: 1.0,
                    comments: 'Reversal en resistencia clave'
                },
                {
                    id: generateId(),
                    entryDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    exitDate: new Date(Date.now() - 0.5 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    instrument: 'BTCUSD',
                    strategy: 'Day Trading',
                    timeframe: 'H1',
                    direction: 'buy',
                    entryPrice: 42000.00,
                    exitPrice: 41800.00,
                    sl: 41500.00,
                    tp: 43000.00,
                    size: 0.1,
                    commission: 10.0,
                    pnl: -220.0,
                    pnlR: -0.4,
                    comments: 'Breakout falso, stop hit'
                }
            ];
            
            sampleTrades.forEach(trade => trades.push(trade));
            saveTrades();
            safeLoadTrades();
            
            showNotification('Datos de ejemplo cargados', 'info');
        }

        // ===== NOTIFICACIONES =====
        function showNotification(message, type = 'info') {
            try {
                // Crear elemento de notificaci√≥n
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 600;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    max-width: 300px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    backdrop-filter: blur(10px);
                `;
                
                switch(type) {
                    case 'success':
                        notification.style.background = 'linear-gradient(90deg, rgba(0,255,136,0.9), rgba(0,240,255,0.9))';
                        notification.style.border = '1px solid var(--neon-green)';
                        break;
                    case 'error':
                        notification.style.background = 'linear-gradient(90deg, rgba(255,85,85,0.9), rgba(255,76,255,0.9))';
                        notification.style.border = '1px solid var(--neon-red)';
                        break;
                    case 'warning':
                        notification.style.background = 'linear-gradient(90deg, rgba(255,255,0,0.9), rgba(255,200,0,0.9))';
                        notification.style.border = '1px solid var(--neon-yellow)';
                        break;
                    default:
                        notification.style.background = 'linear-gradient(90deg, rgba(0,240,255,0.9), rgba(111,92,255,0.9))';
                        notification.style.border = '1px solid var(--neon-cyan)';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Auto-remover despu√©s de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
                
                // A√±adir estilos de animaci√≥n si no existen
                if (!document.getElementById('notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } catch (e) {
                console.error('Error showing notification:', e);
            }
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar salud de los datos
            const health = checkDataHealth();
            
            if (!health.healthy) {
                showRecoveryModal(health.reason);
                isSafeMode = true;
            } else {
                loadInitialData();
            }
            
            // Configurar controles
            document.getElementById('repairDataBtn').addEventListener('click', function() {
                const result = repairData();
                showNotification(`Datos reparados: ${result.repaired} trades recuperados`, 'success');
                document.getElementById('recoveryModal').classList.add('hidden');
                isSafeMode = false;
                safeLoadTrades();
            });
            
            document.getElementById('resetDataBtn').addEventListener('click', function() {
                if (confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esto eliminar√° TODOS los datos permanentemente.')) {
                    localStorage.removeItem(TRADE_STORAGE_KEY);
                    localStorage.removeItem(BACKUP_KEY);
                    trades = [];
                    saveTrades();
                    showNotification('Todos los datos han sido reseteados', 'warning');
                    document.getElementById('recoveryModal').classList.add('hidden');
                    isSafeMode = false;
                    safeLoadTrades();
                }
            });
            
            document.getElementById('ignoreBtn').addEventListener('click', function() {
                document.getElementById('recoveryModal').classList.add('hidden');
                trades = [];
                safeLoadTrades();
            });

            // Bot√≥n gestor de datos
            document.getElementById('dataManagerBtn').addEventListener('click', function() {
                const stats = checkDataHealth();
                const backup = localStorage.getItem(BACKUP_KEY);
                const backupInfo = backup ? JSON.parse(backup) : null;
                
                alert(`üìä GESTOR DE DATOS:\n\n` +
                      `‚Ä¢ Trades actuales: ${trades.length}\n` +
                      `‚Ä¢ Salud datos: ${stats.healthy ? '‚úÖ OK' : '‚ùå CORRUPTO'}\n` +
                      `‚Ä¢ Raz√≥n: ${stats.reason}\n` +
                      `‚Ä¢ Backup disponible: ${backupInfo ? '‚úÖ ' + new Date(backupInfo.timestamp).toLocaleString() : '‚ùå NO'}\n` +
                      `‚Ä¢ Modo seguro: ${isSafeMode ? '‚úÖ ACTIVO' : '‚ùå INACTIVO'}\n` +
                      `‚Ä¢ Trades seleccionados: ${selectedTrades.size}`);
            });

            // Bot√≥n de debug
            document.getElementById('debugBtn').addEventListener('click', debugData);
            
            // Configurar eventos
            setupEventListeners();
            setupAutoCalculations();
            
            // Configurar ordenamiento inicial
            const initialSortHeader = document.querySelector('#tradesTable th[data-sort="entryDate"]');
            if (initialSortHeader) {
                initialSortHeader.classList.add('sort-desc');
            }
            
            // Cargar datos de ejemplo despu√©s de un breve retraso
            setTimeout(() => {
                if (trades.length === 0 && !isSafeMode) {
                    setTimeout(() => {
                        if (confirm('¬øDesea cargar datos de ejemplo para probar la aplicaci√≥n?')) {
                            loadSampleData();
                        }
                    }, 1000);
                }
            }, 500);
        });
    </script>
</body>
</html>